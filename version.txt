# Update SetPolicyDrivenUpdateSourceForDriverUpdates registry
Set-itemproperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name SetPolicyDrivenUpdateSourceForDriverUpdates -Value 0
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\TrustedInstaller" -Name "BlockTimeIncrement" -Value 3600 -type dword


# Install PSWindowsUpdate module
Install-Module -Name PSWindowsUpdate -Force

# Add date to file
$dateTime = Get-Date -Format "MM/dd/yyyy"
$dateTime | Out-File -Append -FilePath "C:\Windows\mitll\Logs\MS_Update.txt"

# Install updates and schedule reboot
Install-WindowsUpdate -MicrosoftUpdate -AcceptAll -IgnoreReboot | Out-File -Append -FilePath "C:\Windows\mitll\Logs\MS_Update.txt"

#Reset registry to initial setting
Set-itemproperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name SetPolicyDrivenUpdateSourceForDriverUpdates -Value 1
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\TrustedInstaller" -Name "BlockTimeIncrement" -Value 900 -type dword

#Suspend Bitlocker if enabled
$bitlockerstatus = get-bitlockervolume -mountpoint "c:"

if ($bitlockerstatus.ProtectionStatus -eq 'On') {
	Suspend-BitLocker -MountPoint "C:" -RebootCount 1
}
