// 5a. Ensure log directory exists
folder create "C:\Windows\mitll\Logs"

// 5b. Create the scheduled task for driver updates
delete __createfile
createfile until END_OF_TASK_SCRIPT
$taskName = "MIT_LL_Driver_Update"
$taskDescription = "Monthly Windows driver updates via Windows Update"
$scriptBlock = @'
Set-itemproperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name SetPolicyDrivenUpdateSourceForDriverUpdates -Value 0 -ErrorAction SilentlyContinue
Install-Module -Name PSWindowsUpdate -Force -ErrorAction SilentlyContinue
$dateTime = Get-Date -Format "MM/dd/yyyy"
$dateTime | Out-File -Append -FilePath "C:\Windows\mitll\Logs\MS_Update.txt"
Install-WindowsUpdate -MicrosoftUpdate -AcceptAll -IgnoreReboot | Out-File -Append -FilePath "C:\Windows\mitll\Logs\MS_Update.txt"
Set-itemproperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name SetPolicyDrivenUpdateSourceForDriverUpdates -Value 1 -ErrorAction SilentlyContinue
$bitlockerstatus = get-bitlockervolume -mountpoint "c:"
if ($bitlockerstatus.ProtectionStatus -eq 'On') {
    Suspend-BitLocker -MountPoint "C:" -RebootCount 1
}
'@
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -Command `"$scriptBlock`""
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit (New-TimeSpan -Hours 2)
Register-ScheduledTask -TaskName $taskName -Description $taskDescription -Action $action -Principal $principal -Settings $settings -Force
Write-Output "Scheduled task '$taskName' created successfully."
END_OF_TASK_SCRIPT

move __createfile "C:\Program Files\LLEA\CreateDriverUpdateTask.ps1"

override wait
hidden=true
wait powershell.exe -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File "C:\Program Files\LLEA\CreateDriverUpdateTask.ps1"

delete "C:\Program Files\LLEA\CreateDriverUpdateTask.ps1"
