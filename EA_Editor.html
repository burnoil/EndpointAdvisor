<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentData.json Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078D7 0%, #0055A4 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
        
        .editor-panel, .preview-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .preview-panel {
            background: #e9ecef;
        }
        
        .panel-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #0078D7;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .autosave-indicator {
            font-size: 11px;
            color: #666;
            font-weight: normal;
        }
        
        .autosave-indicator.saving {
            color: #ffc107;
        }
        
        .autosave-indicator.saved {
            color: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0078D7;
        }
        
        textarea {
            resize: vertical;
            line-height: 1.4;
        }
        
        textarea.code-editor {
            font-family: 'Consolas', 'Monaco', monospace;
            min-height: 500px;
        }
        
        textarea.form-textarea {
            min-height: 80px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button.small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-primary {
            background: #0078D7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0055A4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,215,0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .editor-section {
            display: none;
        }
        
        .editor-section.active {
            display: block;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .help-link {
            color: #0078D7;
            text-decoration: none;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        .preview-window {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 500px;
            max-height: 700px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-header {
            background: #0078D7;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .preview-section {
            border: 1px solid #00008B;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
        }
        
        .preview-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #0078D7;
            cursor: pointer;
            user-select: none;
        }
        
        .preview-section-title:before {
            content: '‚ñº ';
            display: inline-block;
            transition: transform 0.3s;
        }
        
        .preview-section-title.collapsed:before {
            transform: rotate(-90deg);
        }
        
        .preview-section-content {
            font-size: 11px;
            line-height: 1.5;
        }
        
        .preview-section-content.collapsed {
            display: none;
        }
        
        .preview-link {
            color: #0078D7;
            text-decoration: underline;
            cursor: pointer;
            display: block;
            margin-top: 5px;
        }
        
        .preview-alert {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .text-green { color: green; }
        .text-red { color: red; }
        .text-yellow { color: #b8860b; }
        .text-blue { color: blue; }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            color: #0c5460;
            font-size: 13px;
        }
        
        .info-box code {
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        
        .edit-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }
        
        .edit-mode-toggle button {
            flex: 1;
        }
        
        .edit-mode-toggle button.active {
            background: #0078D7;
            color: white;
        }
        
        .form-editor {
            display: none;
        }
        
        .form-editor.active {
            display: block;
        }
        
        .json-editor {
            display: none;
        }
        
        .json-editor.active {
            display: block;
        }
        
        .section-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-card h4 {
            color: #0078D7;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #0078D7;
            padding-bottom: 8px;
        }
        
        .markdown-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .markdown-toolbar button {
            padding: 4px 8px;
            font-size: 12px;
            background: #e9ecef;
            color: #333;
        }
        
        .markdown-toolbar button:hover {
            background: #dee2e6;
            transform: none;
        }
        
        .link-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .link-item input {
            flex: 1;
        }
        
        .link-item button {
            padding: 8px 12px;
        }
        
        .add-link-btn {
            margin-top: 10px;
        }
        
        .form-scroll {
            max-height: 650px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .targeted-announcement {
            border: 2px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: #fff9e6;
            position: relative;
        }
        
        .targeted-announcement h5 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .condition-editor {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .condition-editor label {
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .condition-editor input {
            font-size: 12px;
            padding: 6px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #0078D7;
            padding-bottom: 10px;
        }
        
        .modal-header h3 {
            color: #0078D7;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .diff-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .diff-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .diff-panel h4 {
            margin-bottom: 10px;
            color: #0078D7;
        }
        
        .diff-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }
        
        .diff-line {
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .diff-added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-removed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .template-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .template-card:hover {
            border-color: #0078D7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,215,0.2);
        }
        
        .template-card h4 {
            color: #0078D7;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .template-card p {
            font-size: 13px;
            color: #666;
        }
        
        .help-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0078D7;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,120,215,0.4);
            z-index: 999;
            transition: all 0.3s;
            border: none;
            padding: 0;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,120,215,0.6);
            background: #0055A4;
        }
        
        @media (max-width: 768px) {
            .help-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
        }
        
        .help-modal .modal-content {
            max-width: 1000px;
        }
        
        .help-section {
            margin-bottom: 30px;
        }
        
        .help-section h4 {
            color: #0078D7;
            margin-bottom: 10px;
            font-size: 18px;
            border-left: 4px solid #0078D7;
            padding-left: 10px;
        }
        
        .help-section p, .help-section ul {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .help-section ul {
            margin-left: 20px;
        }
        
        .help-example {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        
        .help-example pre {
            background: #ffffff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            overflow-x: auto;
            margin: 5px 0;
        }
        
        .help-example code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .help-example-title {
            font-weight: 600;
            color: #0078D7;
            margin-bottom: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .help-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .help-tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .help-tab:hover {
            color: #0078D7;
            transform: none;
        }
        
        .help-tab.active {
            color: #0078D7;
            border-bottom-color: #0078D7;
        }
        
        .help-content {
            display: none;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .help-content.active {
            display: block;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            color: #856404;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .tip-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            color: #0c5460;
        }
        
        .tip-box strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù ContentData.json Editor</h1>
            <p>Edit your Lincoln Laboratory Endpoint Advisor configuration directly on GitHub</p>
        </div>
        
        <div class="content">
            <!-- Authentication Section -->
            <div id="authSection" class="auth-section">
                <h3>GitHub Authentication</h3>
                <div class="form-group">
                    <label for="repoOwner">Repository Owner:</label>
                    <input type="text" id="repoOwner" value="burnoil" placeholder="e.g., burnoil">
                </div>
                <div class="form-group">
                    <label for="repoName">Repository Name:</label>
                    <input type="text" id="repoName" value="EndpointAdvisor" placeholder="e.g., EndpointAdvisor">
                </div>
                <div class="form-group">
                    <label for="branch">Branch:</label>
                    <input type="text" id="branch" value="main" placeholder="e.g., main">
                </div>
                <div class="form-group">
                    <label for="filePath">File Path:</label>
                    <input type="text" id="filePath" value="ContentData.json" placeholder="e.g., ContentData.json">
                </div>
                <div class="form-group">
                    <label for="apiBase">GitHub Instance:</label>
                    <select id="apiBase" onchange="handleApiBaseChange()">
                        <option value="https://api.github.com">Public GitHub (github.com)</option>
                        <option value="https://github.company.com/api/v3" selected>Internal GitHub Enterprise</option>
                        <option value="custom">Custom URL...</option>
                    </select>
                    <input type="text" id="apiBaseCustom" placeholder="Enter custom API URL (e.g., https://github.yourcompany.com/api/v3)" style="display: none; margin-top: 10px;">
                    <p class="help-text">
                        Select your GitHub instance. For Enterprise, the API URL format is usually: https://your-github-domain/api/v3<br>
                        <small style="color: #999;">üìù Note: Edit the HTML to customize the dropdown options for your organization's GitHub instances</small>
                    </p>
                </div>
                <div class="form-group">
                    <label for="token">GitHub Personal Access Token:</label>
                    <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="help-text">
                        Need a token? Create one at 
                        <a href="https://github.com/settings/tokens/new" target="_blank" class="help-link">GitHub Settings</a>
                        with "repo" scope
                    </p>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="loadFile()">Load File</button>
                    <button class="btn-secondary" onclick="loadTemplate()">üìã Load Template</button>
                    <button class="btn-secondary" onclick="restoreAutosave()">üíæ Restore Auto-save</button>
                    <button class="btn-secondary" onclick="checkTokenPermissions()">üîë Check Token Permissions</button>
                    <button class="btn-secondary" onclick="openHelpModal()">‚ùì Help</button>
                </div>
                <div id="authStatus"></div>
            </div>
            
            <!-- Editor Section -->
            <div id="editorSection" class="editor-section">
                <h3>Content Editor with Live Preview</h3>
                
                <div class="info-box">
                    <strong>üìñ Markdown Support:</strong>
                    Use <code>**bold**</code>, <code>*italic*</code>, <code>__underline__</code>, 
                    <code>[green]text[/green]</code>, <code>[red]text[/red]</code>, 
                    <code>[yellow]text[/yellow]</code>, <code>[blue]text[/blue]</code>
                    <span class="autosave-indicator" id="autosaveStatus"></span>
                </div>
                
                <div class="edit-mode-toggle">
                    <button id="formModeBtn" class="active" onclick="switchMode('form')">üìù Form Editor (Easy)</button>
                    <button id="jsonModeBtn" onclick="switchMode('json')">üíª JSON Editor (Advanced)</button>
                </div>
                
                <div class="editor-container">
                    <!-- Form Editor Panel -->
                    <div class="editor-panel">
                        <div class="panel-title">üìù Editor</div>
                        
                        <!-- Form Editor -->
                        <div id="formEditor" class="form-editor active">
                            <div class="form-scroll">
                                <!-- Announcements Section -->
                                <div class="section-card">
                                    <h4>üì¢ Announcements</h4>
                                    <div class="form-group">
                                        <label>Main Text:</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('announcementText', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('announcementText', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('announcementText', '__', '__')"><u>U</u></button>
                                            <button onclick="insertMarkdown('announcementText', '[green]', '[/green]')">üü¢</button>
                                            <button onclick="insertMarkdown('announcementText', '[red]', '[/red]')">üî¥</button>
                                            <button onclick="insertMarkdown('announcementText', '[yellow]', '[/yellow]')">üü°</button>
                                        </div>
                                        <textarea id="announcementText" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Details (Optional):</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('announcementDetails', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('announcementDetails', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('announcementDetails', '__', '__')"><u>U</u></button>
                                        </div>
                                        <textarea id="announcementDetails" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Links:</label>
                                        <div id="announcementLinks"></div>
                                        <button class="btn-secondary small add-link-btn" onclick="addLink('announcementLinks')">+ Add Link</button>
                                    </div>
                                </div>
                                
                                <!-- Targeted Announcements Section -->
                                <div class="section-card">
                                    <h4>üéØ Targeted Announcements</h4>
                                    <p class="help-text" style="margin-bottom: 15px;">Create conditional announcements that appear only for specific users (based on registry keys)</p>
                                    <div id="targetedAnnouncementsContainer"></div>
                                    <button class="btn-secondary small" onclick="addTargetedAnnouncement()">+ Add Targeted Announcement</button>
                                </div>
                                
                                <!-- Support Section -->
                                <div class="section-card">
                                    <h4>üÜò Support</h4>
                                    <div class="form-group">
                                        <label>Support Text:</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('supportText', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('supportText', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('supportText', '__', '__')"><u>U</u></button>
                                        </div>
                                        <textarea id="supportText" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Links:</label>
                                        <div id="supportLinks"></div>
                                        <button class="btn-secondary small add-link-btn" onclick="addLink('supportLinks')">+ Add Link</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JSON Editor -->
                        <div id="jsonEditor" class="json-editor">
                            <textarea id="jsonEditorText" class="code-editor" spellcheck="false"></textarea>
                        </div>
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="preview-panel">
                        <div class="panel-title">
                            üëÅÔ∏è Live Preview
                            <span class="live-indicator"></span>
                        </div>
                        <div class="preview-window" id="previewWindow">
                            <div class="preview-header">Lincoln Laboratory Endpoint Advisor</div>
                            <div id="previewContent">
                                <p style="text-align: center; color: #666; padding: 20px;">
                                    Load or edit content to see preview
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-success" onclick="showDiffAndSave()">üíæ Save to GitHub</button>
                    <button class="btn-secondary" onclick="validateJson()">‚úì Validate JSON</button>
                    <button class="btn-warning" onclick="formatJson()">‚ú® Format/Prettify</button>
                    <button class="btn-secondary" onclick="resetEditor()">üîÑ Reload from GitHub</button>
                    <button class="btn-secondary" onclick="openHelpModal()">‚ùì Help</button>
                </div>
                
                <div id="editorStatus"></div>
            </div>
        </div>
    </div>

    <!-- Diff Modal -->
    <div id="diffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìä Review Changes Before Saving</h3>
                <button class="close-modal" onclick="closeDiffModal()">√ó</button>
            </div>
            <div class="diff-view">
                <div class="diff-panel">
                    <h4>‚ùå Current (GitHub)</h4>
                    <div id="diffOriginal" class="diff-content"></div>
                </div>
                <div class="diff-panel">
                    <h4>‚úÖ New (Your Changes)</h4>
                    <div id="diffModified" class="diff-content"></div>
                </div>
            </div>
            <div class="button-group" style="margin-top: 20px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeDiffModal()">Cancel</button>
                <button class="btn-success" onclick="confirmSave()">Confirm & Save to GitHub</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Choose a Template</h3>
                <button class="close-modal" onclick="closeTemplateModal()">√ó</button>
            </div>
            <div class="template-grid">
                <div class="template-card" onclick="applyTemplate('maintenance')">
                    <h4>üîß System Maintenance</h4>
                    <p>Scheduled maintenance announcement</p>
                </div>
                <div class="template-card" onclick="applyTemplate('security')">
                    <h4>üîí Security Alert</h4>
                    <p>Important security update notice</p>
                </div>
                <div class="template-card" onclick="applyTemplate('patching')">
                    <h4>‚öôÔ∏è Patching Notice</h4>
                    <p>Monthly patch deployment</p>
                </div>
                <div class="template-card" onclick="applyTemplate('training')">
                    <h4>üìö Training Reminder</h4>
                    <p>Required training notification</p>
                </div>
                <div class="template-card" onclick="applyTemplate('holiday')">
                    <h4>üéâ Holiday Schedule</h4>
                    <p>Holiday hours and closures</p>
                </div>
                <div class="template-card" onclick="applyTemplate('pilot')">
                    <h4>üöÄ Pilot Program</h4>
                    <p>Targeted pilot announcement</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ùì Help & Documentation</h3>
                <button class="close-modal" onclick="closeHelpModal()">√ó</button>
            </div>
            
            <div class="help-tabs">
                <button class="help-tab active" onclick="showHelpTab('getting-started')">Getting Started</button>
                <button class="help-tab" onclick="showHelpTab('markdown')">Markdown Formatting</button>
                <button class="help-tab" onclick="showHelpTab('targeted')">Targeted Announcements</button>
                <button class="help-tab" onclick="showHelpTab('best-practices')">Best Practices</button>
                <button class="help-tab" onclick="showHelpTab('troubleshooting')">Troubleshooting</button>
            </div>
            
            <!-- Getting Started Tab -->
            <div id="help-getting-started" class="help-content active">
                <div class="help-section">
                    <h4>üöÄ Quick Start Guide</h4>
                    <p>Welcome to the Endpoint Advisor Content Editor! This tool helps you manage announcements and support information that appear on user endpoints.</p>
                    
                    <p><strong>Step 1: Connect to GitHub</strong></p>
                    <ul>
                        <li>Select your GitHub instance from the dropdown (Public or Enterprise)</li>
                        <li>Enter your repository details (owner, repo name, branch)</li>
                        <li>Create a Personal Access Token at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a> with "repo" scope</li>
                        <li>Paste the token and click "Load File"</li>
                    </ul>
                    
                    <p><strong>Step 2: Edit Your Content</strong></p>
                    <ul>
                        <li><strong>Form Editor (Easy):</strong> Use the friendly form interface to edit content without touching JSON</li>
                        <li><strong>JSON Editor (Advanced):</strong> Edit the raw JSON for full control</li>
                        <li>Changes are auto-saved to your browser every 2 seconds</li>
                    </ul>
                    
                    <p><strong>Step 3: Preview & Save</strong></p>
                    <ul>
                        <li>View live preview on the right side as you type</li>
                        <li>Click "Save to GitHub" to review changes in diff viewer</li>
                        <li>Confirm and enter a commit message to publish</li>
                    </ul>
                    
                    <div class="tip-box">
                        <strong>üí° Pro Tip:</strong>
                        Use templates to get started quickly! Click "Load Template" for pre-made announcements.
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üè¢ Customizing for Your Organization</h4>
                    <p>To customize the GitHub instance dropdown for your organization:</p>
                    
                    <div class="help-example">
                        <div class="help-example-title">1. Find the Dropdown in the HTML</div>
                        <p>Look for the <code>&lt;select id="apiBase"&gt;</code> section around line 560</p>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">2. Add Your Organization's GitHub URLs</div>
                        <pre style="white-space: pre-wrap;">&lt;select id="apiBase" onchange="handleApiBaseChange()"&gt;
  &lt;option value="https://api.github.com"&gt;Public GitHub&lt;/option&gt;
  &lt;option value="https://github.yourcompany.com/api/v3" selected&gt;Production GitHub&lt;/option&gt;
  &lt;option value="https://github-dev.yourcompany.com/api/v3"&gt;Dev GitHub&lt;/option&gt;
  &lt;option value="custom"&gt;Custom URL...&lt;/option&gt;
&lt;/select&gt;</pre>
                        <p style="margin-top: 8px;"><strong>Tips:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Add <code>selected</code> attribute to the option you want as default</li>
                            <li>Use descriptive names (Production, Dev, Staging, etc.)</li>
                            <li>Always keep the "Custom URL..." option for flexibility</li>
                            <li>API URL format: <code>https://your-github-domain/api/v3</code></li>
                        </ul>
                    </div>
                    
                    <div class="tip-box">
                        <strong>üí° For IT Administrators:</strong>
                        Save this HTML file with your organization's pre-configured URLs and distribute it to your team. Users won't need to know the API endpoints!
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üîß Key Features</h4>
                    <ul>
                        <li><strong>Auto-Save:</strong> Your work is automatically saved to browser storage</li>
                        <li><strong>Diff Viewer:</strong> Review all changes before publishing to GitHub</li>
                        <li><strong>Live Preview:</strong> See exactly how content will appear to users</li>
                        <li><strong>Templates:</strong> Pre-built announcements for common scenarios</li>
                        <li><strong>Markdown Support:</strong> Rich text formatting with simple syntax</li>
                        <li><strong>Targeted Announcements:</strong> Show messages to specific user groups</li>
                        <li><strong>BigFix Scripts:</strong> Ready-to-use action scripts for registry setup (see Targeted Announcements tab)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Markdown Tab -->
            <div id="help-markdown" class="help-content">
                <div class="help-section">
                    <h4>üìù Markdown Formatting Guide</h4>
                    <p>Use these simple codes to format your text:</p>
                    
                    <div class="help-example">
                        <div class="help-example-title">Bold Text:</div>
                        <code>**This text is bold**</code>
                        <div style="margin-top: 8px;">Result: <strong>This text is bold</strong></div>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Italic Text:</div>
                        <code>*This text is italic*</code>
                        <div style="margin-top: 8px;">Result: <em>This text is italic</em></div>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Underlined Text:</div>
                        <code>__This text is underlined__</code>
                        <div style="margin-top: 8px;">Result: <u>This text is underlined</u></div>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Colored Text:</div>
                        <code>[green]Success message[/green]</code><br>
                        <code>[red]Error or warning[/red]</code><br>
                        <code>[yellow]Caution message[/yellow]</code><br>
                        <code>[blue]Information[/blue]</code>
                        <div style="margin-top: 8px;">
                            Result: <span style="color: green;">Success message</span> / 
                            <span style="color: red;">Error or warning</span> / 
                            <span style="color: #b8860b;">Caution message</span> / 
                            <span style="color: blue;">Information</span>
                        </div>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Combining Styles:</div>
                        <code>[red]**Important:**[/red] Please restart your computer.</code>
                        <div style="margin-top: 8px;">Result: <span style="color: red;"><strong>Important:</strong></span> Please restart your computer.</div>
                    </div>
                    
                    <div class="tip-box">
                        <strong>üí° Quick Tip:</strong>
                        Use the toolbar buttons above text fields to insert formatting automatically!
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üìã Real-World Example</h4>
                    <div class="help-example">
                        <div class="help-example-title">Input:</div>
                        <pre style="white-space: pre-wrap;">**Starting today at 3pm** the Windows monthly patches will be made available.

[yellow]**Important:**[/yellow] Computers will reboot after installing updates.

Daytime patching begins [red]October 22nd[/red] for any computers still needing updates.</pre>
                    </div>
                    
                    <p style="margin-top: 15px;"><strong>Output:</strong></p>
                    <div style="padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                        <strong>Starting today at 3pm</strong> the Windows monthly patches will be made available.<br><br>
                        <span style="color: #b8860b;"><strong>Important:</strong></span> Computers will reboot after installing updates.<br><br>
                        Daytime patching begins <span style="color: red;">October 22nd</span> for any computers still needing updates.
                    </div>
                </div>
            </div>
            
            <!-- Targeted Announcements Tab -->
            <div id="help-targeted" class="help-content">
                <div class="help-section">
                    <h4>üéØ What are Targeted Announcements?</h4>
                    <p>Targeted announcements allow you to show different messages to specific groups of users based on registry values on their computers.</p>
                    
                    <div class="tip-box">
                        <strong>üìã Quick Workflow:</strong>
                        <ol style="margin-left: 20px; margin-top: 5px;">
                            <li>Create BigFix Action to set registry key on target computers (see templates below)</li>
                            <li>Deploy BigFix Action to specific computer group</li>
                            <li>Create targeted announcement in this editor with matching registry condition</li>
                            <li>Save and publish - announcement appears only on computers with registry key</li>
                        </ol>
                    </div>
                    
                    <p><strong>Use Cases:</strong></p>
                    <ul>
                        <li>Show pilot program instructions only to pilot participants</li>
                        <li>Display Windows 11-specific messages only to Windows 11 users</li>
                        <li>Communicate department-specific information</li>
                        <li>Provide VPN instructions only to remote users</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>‚öôÔ∏è How Registry Conditions Work</h4>
                    <p>The Endpoint Advisor script checks the Windows registry on each computer. If the registry matches your condition, the targeted announcement is displayed.</p>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example Registry Condition:</div>
                        <strong>Registry Path:</strong> <code>HKLM:\SOFTWARE\MITLL\Targeting</code><br>
                        <strong>Value Name:</strong> <code>Group</code><br>
                        <strong>Expected Value:</strong> <code>VPN-Pilot</code>
                    </div>
                    
                    <p>This means: "Show this announcement only on computers where the registry key <code>HKLM:\SOFTWARE\MITLL\Targeting\Group</code> has a value of <code>VPN-Pilot</code>"</p>
                    
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Important:</strong>
                        You (or your IT team) must create and set these registry values on target computers. The editor doesn't create them automatically.
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üîß Creating Targeted Announcements</h4>
                    <ol>
                        <li>In the Form Editor, scroll to "Targeted Announcements"</li>
                        <li>Click "+ Add Targeted Announcement"</li>
                        <li>Check "Enabled" to activate it</li>
                        <li>Choose "Append to Default" to show it alongside the default announcement, or uncheck to replace it</li>
                        <li>Enter your text, details, and links</li>
                        <li>Set the registry condition (path, value name, expected value)</li>
                    </ol>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example: Pilot Program Announcement</div>
                        <strong>Text:</strong> <code>[green]**Pilot Program**[/green] - You've been selected!</code><br>
                        <strong>Details:</strong> <code>Install the pilot software by Friday...</code><br>
                        <strong>Enabled:</strong> ‚úì Checked<br>
                        <strong>Append to Default:</strong> ‚úì Checked<br>
                        <strong>Registry Path:</strong> <code>HKLM:\SOFTWARE\MITLL\Targeting</code><br>
                        <strong>Value Name:</strong> <code>Group</code><br>
                        <strong>Expected Value:</strong> <code>Pilot</code>
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üìä Append vs Replace</h4>
                    <ul>
                        <li><strong>Append to Default (checked):</strong> Shows both the default announcement AND the targeted announcement</li>
                        <li><strong>Replace Default (unchecked):</strong> Shows ONLY the targeted announcement (hides default)</li>
                    </ul>
                    
                    <div class="tip-box">
                        <strong>üí° Best Practice:</strong>
                        Use "Append" for additional information (pilot instructions). Use "Replace" when the targeted message is completely different (maintenance window specific to one building).
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üîß BigFix Action Script Templates</h4>
                    <p>Use these BigFix Action scripts to create the registry keys that trigger targeted announcements. Deploy these to specific computer groups.</p>
                    
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Important:</strong>
                        These scripts must be deployed BEFORE the targeted announcement will appear. Test on a small group first!
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Template 1: Using regset (Preferred Method)</div>
                        <pre style="white-space: pre-wrap;">// Create the registry key path if it doesn't exist
regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL]" "Targeting"=""

// Set the targeting value
regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "Group"="Pilot"</pre>
                        <button class="btn-secondary small" onclick="copyToClipboard('regset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL&quot;] &quot;Targeting&quot;=&quot;&quot;\n\nregset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;Group&quot;=&quot;Pilot&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Template 2: Using reg.exe (Alternative Method)</div>
                        <pre style="white-space: pre-wrap;">// Create registry key and set value
waithidden reg.exe add "HKLM\SOFTWARE\MITLL\Targeting" /v Group /t REG_SZ /d "Pilot" /f</pre>
                        <button class="btn-secondary small" onclick="copyToClipboard('waithidden reg.exe add &quot;HKLM\\SOFTWARE\\MITLL\\Targeting&quot; /v Group /t REG_SZ /d &quot;Pilot&quot; /f')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <p style="margin-top: 20px;"><strong>Common Use Case Examples:</strong></p>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example 1: VPN Pilot Group</div>
                        <pre style="white-space: pre-wrap;">regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "Group"="VPN-Pilot"</pre>
                        <p style="margin-top: 8px; font-size: 12px;">Then in editor, set Expected Value to: <code>VPN-Pilot</code></p>
                        <button class="btn-secondary small" onclick="copyToClipboard('regset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;Group&quot;=&quot;VPN-Pilot&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example 2: Windows 11 Computers</div>
                        <pre style="white-space: pre-wrap;">regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "OS_Version"="Win11"</pre>
                        <p style="margin-top: 8px; font-size: 12px;">Then in editor, set Value Name to: <code>OS_Version</code> and Expected Value to: <code>Win11</code></p>
                        <button class="btn-secondary small" onclick="copyToClipboard('regset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;OS_Version&quot;=&quot;Win11&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example 3: Department-Specific (Engineering)</div>
                        <pre style="white-space: pre-wrap;">regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "Department"="Engineering"</pre>
                        <p style="margin-top: 8px; font-size: 12px;">Then in editor, set Value Name to: <code>Department</code> and Expected Value to: <code>Engineering</code></p>
                        <button class="btn-secondary small" onclick="copyToClipboard('regset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;Department&quot;=&quot;Engineering&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Example 4: Building/Location-Specific</div>
                        <pre style="white-space: pre-wrap;">regset "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "Building"="Bldg-32"</pre>
                        <p style="margin-top: 8px; font-size: 12px;">Then in editor, set Value Name to: <code>Building</code> and Expected Value to: <code>Bldg-32</code></p>
                        <button class="btn-secondary small" onclick="copyToClipboard('regset [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;Building&quot;=&quot;Bldg-32&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="tip-box" style="margin-top: 20px;">
                        <strong>üí° Pro Tips:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Use descriptive value names that make sense: "Group", "Department", "Building", "OS_Version"</li>
                            <li>Keep values simple and consistent: "Pilot" not "Pilot-Program-2024"</li>
                            <li>Document which BigFix fixlets set which registry values</li>
                            <li>You can use multiple registry values for different targeting scenarios</li>
                            <li>Test on a single computer first before deploying widely</li>
                        </ul>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Verification Script (PowerShell)</div>
                        <p>Use this to verify the registry key was created correctly:</p>
                        <pre style="white-space: pre-wrap;">Get-ItemProperty -Path "HKLM:\SOFTWARE\MITLL\Targeting" -ErrorAction SilentlyContinue</pre>
                        <button class="btn-secondary small" onclick="copyToClipboard('Get-ItemProperty -Path &quot;HKLM:\\SOFTWARE\\MITLL\\Targeting&quot; -ErrorAction SilentlyContinue')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">Removal Script (If needed)</div>
                        <p>To remove the targeting registry value:</p>
                        <pre style="white-space: pre-wrap;">regdelete "[HKEY_LOCAL_MACHINE\SOFTWARE\MITLL\Targeting]" "Group"</pre>
                        <button class="btn-secondary small" onclick="copyToClipboard('regdelete [&quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\MITLL\\Targeting&quot;] &quot;Group&quot;')" style="margin-top: 10px;">üìã Copy to Clipboard</button>
                    </div>
                </div>
            </div>
            
            <!-- Best Practices Tab -->
            <div id="help-best-practices" class="help-content">
                <div class="help-section">
                    <h4>‚ú® Writing Effective Announcements</h4>
                    
                    <p><strong>Keep it Clear and Concise:</strong></p>
                    <ul>
                        <li>Use short, simple sentences</li>
                        <li>Put the most important information first</li>
                        <li>Use bullet points for lists of actions</li>
                        <li>Avoid technical jargon when possible</li>
                    </ul>
                    
                    <p><strong>Use Formatting Strategically:</strong></p>
                    <ul>
                        <li><span style="color: red;">Red</span> for urgent warnings or deadlines</li>
                        <li><span style="color: green;">Green</span> for positive news or success messages</li>
                        <li><span style="color: #b8860b;">Yellow</span> for cautions or important notices</li>
                        <li><strong>Bold</strong> for key terms and action items</li>
                    </ul>
                    
                    <div class="help-example">
                        <div class="help-example-title">‚ùå Not Great:</div>
                        <pre style="white-space: pre-wrap;">The IT department will be performing necessary system maintenance on the network infrastructure components which may result in intermittent connectivity issues.</pre>
                    </div>
                    
                    <div class="help-example">
                        <div class="help-example-title">‚úÖ Better:</div>
                        <pre style="white-space: pre-wrap;">**Network Maintenance** - [yellow]Brief outages expected[/yellow]

**When:** Tonight, 11 PM - 2 AM
**Impact:** Network may be unavailable for 5-10 minutes

Save your work before leaving for the day.</pre>
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üóìÔ∏è Timing & Updates</h4>
                    <ul>
                        <li>Post announcements at least 24-48 hours in advance when possible</li>
                        <li>Update deadlines regularly (don't leave expired dates)</li>
                        <li>Clear old announcements after events are complete</li>
                        <li>The app refreshes every 10-20 minutes, so changes appear quickly</li>
                    </ul>
                    
                    <div class="tip-box">
                        <strong>üí° Pro Tip:</strong>
                        Use commit messages to track what you changed: "Updated patch date to Oct 22" or "Added pilot program announcement"
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üîó Links Best Practices</h4>
                    <ul>
                        <li>Use descriptive link names: "Training Portal" not "Click Here"</li>
                        <li>Test all links before publishing</li>
                        <li>Use internal knowledge base articles when available</li>
                        <li>Keep the number of links manageable (3-5 maximum)</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>‚úÖ Validation Checklist</h4>
                    <p>Before saving, verify:</p>
                    <ul>
                        <li>‚òëÔ∏è Dates and times are correct</li>
                        <li>‚òëÔ∏è Contact information is accurate</li>
                        <li>‚òëÔ∏è All links work</li>
                        <li>‚òëÔ∏è Spelling and grammar are correct</li>
                        <li>‚òëÔ∏è Formatting displays correctly in preview</li>
                        <li>‚òëÔ∏è Targeted announcements have correct registry paths</li>
                        <li>‚òëÔ∏è JSON validates without errors</li>
                    </ul>
                </div>
            </div>
            
            <!-- Troubleshooting Tab -->
            <div id="help-troubleshooting" class="help-content">
                <div class="help-section">
                    <h4>üîç Common Issues & Solutions</h4>
                    
                    <p><strong>Problem: "GitHub API error: 401" even with "repo" scope</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        If your token has "repo" checked but still getting 401 errors:
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li><strong>For Enterprise GitHub with SSO:</strong>
                                <ol style="margin-left: 20px; margin-top: 5px;">
                                    <li>Go to GitHub Settings ‚Üí Personal access tokens</li>
                                    <li>Find your token in the list</li>
                                    <li>Click "Configure SSO" or "Authorize SSO" next to it</li>
                                    <li>Select your organization and authorize</li>
                                    <li>This is required even if the token has "repo" scope!</li>
                                </ol>
                            </li>
                            <li><strong>Check organization restrictions:</strong> Your organization may have additional access controls</li>
                            <li><strong>Verify you're not using a fine-grained token:</strong> Use "classic" tokens with full "repo" scope</li>
                            <li><strong>Check branch protection:</strong> Use "Check Token Permissions" button - protected branches may block direct commits</li>
                            <li><strong>Try the browser console:</strong> Open DevTools (F12), try to save, and look at the Network tab for the exact error response</li>
                            <li><strong>Token might be expired:</strong> Even if it shows in settings, regenerate a fresh one</li>
                        </ul>
                    </div>
                    
                    <p><strong>Problem: "GitHub API error: 404"</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Verify the GitHub Instance dropdown is set to the correct environment</li>
                            <li>Check that your repository owner, name, branch, and file path are correct</li>
                            <li>The file must exist in the repository</li>
                            <li>For Enterprise GitHub, ensure the API URL is correct</li>
                        </ul>
                    </div>
                    
                    <p><strong>Problem: "Invalid JSON" error</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Click "Validate JSON" to see the specific error</li>
                            <li>Switch to JSON Editor mode to see the raw JSON</li>
                            <li>Common issues: missing commas, unclosed quotes, unmatched brackets</li>
                            <li>Click "Format/Prettify" to auto-fix formatting</li>
                        </ul>
                    </div>
                    
                    <p><strong>Problem: Changes not appearing on endpoints</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Wait 10-20 minutes - the app refreshes periodically</li>
                            <li>Verify the file was saved to GitHub (check commit history)</li>
                            <li>Ensure the URL in the PowerShell script matches your repository</li>
                            <li>Check that endpoints can reach GitHub (not blocked by firewall)</li>
                        </ul>
                    </div>
                    
                    <p><strong>Problem: Targeted announcement not showing</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Verify "Enabled" is checked in the editor</li>
                            <li>Confirm the registry key exists on the target computer</li>
                            <li>Check registry path, value name, and expected value match exactly (case-sensitive)</li>
                            <li>Use PowerShell to verify: <code>Get-ItemProperty -Path "HKLM:\SOFTWARE\MITLL\Targeting"</code></li>
                            <li>See the "Targeted Announcements" tab for BigFix scripts to create registry keys</li>
                        </ul>
                    </div>
                    
                    <p><strong>Problem: Markdown formatting not displaying</strong></p>
                    <div class="warning-box">
                        <strong>Solution:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Check that markdown syntax is correct (see Markdown tab)</li>
                            <li>Ensure opening and closing tags match: <code>[red]...[/red]</code></li>
                            <li>Verify no extra spaces in color tags</li>
                            <li>Check the live preview to see how it will appear</li>
                        </ul>
                    </div>
                </div>
                
                <div class="help-section">
                    <h4>üíæ Auto-Save Issues</h4>
                    <p><strong>Problem: Auto-save not working</strong></p>
                    <ul>
                        <li>Ensure browser cookies/storage are enabled</li>
                        <li>Check browser console for errors (F12)</li>
                        <li>Try a different browser</li>
                        <li>Auto-save is stored locally - it won't sync between computers</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>üÜò Getting Help</h4>
                    <p>If you continue to experience issues:</p>
                    <ul>
                        <li>Use the "Check Token Permissions" button to diagnose authentication issues</li>
                        <li>Check the browser console (F12) for error messages</li>
                        <li>Try the JSON Editor mode to see raw data</li>
                        <li>Export your JSON and test it in a JSON validator</li>
                        <li>Verify you have write access to the repository in GitHub</li>
                        <li>Contact your IT support team</li>
                        <li>Email: endpointengineering@ll.mit.edu</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <div class="help-button" onclick="openHelpModal()" title="Help & Documentation">
        ‚ùì
    </div>

    <script>
        let currentSha = null;
        let currentContent = null;
        let currentData = null;
        let isUpdatingFromJson = false;
        let autosaveTimer = null;
        let targetedAnnouncementCounter = 0;

        // ========================================
        // CONFIGURATION: Customize these URLs for your organization
        // ========================================
        // To add more GitHub instances, add additional <option> tags in the HTML above
        // Example: <option value="https://git.yourcompany.com/api/v3">Dev GitHub</option>
        // The first option is selected by default
        // ========================================

        // Templates
        const templates = {
            maintenance: {
                Announcements: {
                    Default: {
                        Text: "**Scheduled System Maintenance** - [yellow]Systems will be offline[/yellow]",
                        Details: "**Date:** [Specify date and time]\n**Duration:** Approximately 4 hours\n**Impact:** Systems will be unavailable during this window\n\nPlease save your work and log off before maintenance begins.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Questions about the maintenance? Contact IT Support at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            security: {
                Announcements: {
                    Default: {
                        Text: "[red]**SECURITY ALERT**[/red] - Action Required",
                        Details: "A critical security update has been released.\n\n**Action Required:**\n- Update your system immediately\n- Restart your computer when prompted\n- Contact IT if you experience issues",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Security concerns? Contact ISD Support immediately at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            patching: {
                Announcements: {
                    Default: {
                        Text: "**Monthly Patch Deployment** - Windows and Office updates available",
                        Details: "**Starting today** the monthly patches will be made available. Updates will be automatically installed overnight.\n\n[yellow]**Important:**[/yellow] Computers will reboot after installing updates. Save your work before leaving.\n\nDaytime patching begins tomorrow for any computers still needing updates.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Patching issues? Call ISD Support at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            training: {
                Announcements: {
                    Default: {
                        Text: "**Required Training Reminder** - Deadline Approaching",
                        Details: "[red]**Action Required:**[/red] Complete your mandatory security awareness training by [deadline date].\n\n**Steps:**\n1. Log into the training portal\n2. Complete all required modules\n3. Verify completion certificate\n\nFailure to complete may result in system access restrictions.",
                        Links: [
                            { Name: "Training Portal", Url: "https://training.example.com" }
                        ]
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Training questions? Contact Training Team or call 781-981-4357 (HELP).",
                    Links: []
                }
            },
            holiday: {
                Announcements: {
                    Default: {
                        Text: "**Holiday Schedule** - Support Hours Modified",
                        Details: "**Holiday:** [Holiday Name] - [Date]\n\n**ISD Support Center Hours:**\n- [Date]: Closed\n- [Date]: Limited hours (9 AM - 12 PM)\n\n[green]Normal operations resume [date][/green]\n\nEmergency support remains available 24/7.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "For emergency support during holidays, call 781-981-4357 (HELP).",
                    Links: []
                }
            },
            pilot: {
                Announcements: {
                    Default: {
                        Text: "No general announcements at this time.",
                        Details: "",
                        Links: []
                    },
                    Targeted: [
                        {
                            Text: "[green]**Pilot Program**[/green] - You've been selected!",
                            Details: "You're part of the [Program Name] pilot group.\n\n**Next Steps:**\n- Review pilot documentation\n- Install pilot software by [date]\n- Provide feedback via survey\n\nThank you for participating!",
                            Links: [
                                { Name: "Pilot Documentation", Url: "https://example.com/pilot" }
                            ],
                            Enabled: true,
                            AppendToDefault: false,
                            Condition: {
                                Type: "Registry",
                                Path: "HKLM:\\SOFTWARE\\MITLL\\Targeting",
                                Name: "Group",
                                Value: "Pilot"
                            }
                        }
                    ]
                },
                Support: {
                    Text: "Pilot program support: email pilot@example.com or call 781-981-4357 (HELP).",
                    Links: []
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const jsonEditorText = document.getElementById('jsonEditorText');
            jsonEditorText.addEventListener('input', debounce(() => {
                if (!isUpdatingFromJson) {
                    updateFromJson();
                    scheduleAutosave();
                }
            }, 500));
            
            checkAutosave();
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Auto-save functionality
        function scheduleAutosave() {
            const status = document.getElementById('autosaveStatus');
            status.textContent = '‚è≥ Saving...';
            status.className = 'autosave-indicator saving';
            
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                const content = document.getElementById('jsonEditorText').value;
                if (content.trim()) {
                    localStorage.setItem('endpointadvisor_autosave', content);
                    localStorage.setItem('endpointadvisor_autosave_time', new Date().toISOString());
                    status.textContent = '‚úì Auto-saved';
                    status.className = 'autosave-indicator saved';
                    setTimeout(() => {
                        status.textContent = '';
                        status.className = 'autosave-indicator';
                    }, 3000);
                }
            }, 2000);
        }

        function checkAutosave() {
            const saved = localStorage.getItem('endpointadvisor_autosave');
            const saveTime = localStorage.getItem('endpointadvisor_autosave_time');
            
            if (saved && saveTime) {
                const time = new Date(saveTime);
                const timeDiff = (new Date() - time) / 1000 / 60; // minutes
                
                if (timeDiff < 60) { // Only show if less than 1 hour old
                    const restoreBtn = document.querySelector('[onclick="restoreAutosave()"]');
                    if (restoreBtn) {
                        restoreBtn.style.background = '#28a745';
                        restoreBtn.style.color = 'white';
                        restoreBtn.textContent = `üíæ Restore Auto-save (${Math.round(timeDiff)} min ago)`;
                    }
                }
            }
        }

        function restoreAutosave() {
            const saved = localStorage.getItem('endpointadvisor_autosave');
            if (saved) {
                if (confirm('Restore your auto-saved work? This will replace any current unsaved changes.')) {
                    document.getElementById('jsonEditorText').value = saved;
                    formatJson();
                    updateFormFromJson();
                    updatePreview();
                    document.getElementById('editorSection').classList.add('active');
                    showStatus('authStatus', '‚úì Auto-saved content restored!', 'success');
                    document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                showStatus('authStatus', 'No auto-saved content found.', 'info');
            }
        }

        function getApiBaseUrl() {
            const select = document.getElementById('apiBase');
            const customInput = document.getElementById('apiBaseCustom');
            
            if (select.value === 'custom') {
                const customUrl = customInput.value.trim();
                return customUrl ? customUrl.replace(/\/$/, '') : 'https://api.github.com';
            }
            
            return select.value;
        }

        function handleApiBaseChange() {
            const select = document.getElementById('apiBase');
            const customInput = document.getElementById('apiBaseCustom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        async function checkTokenPermissions() {
            const token = document.getElementById('token').value;
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const apiBase = getApiBaseUrl();

            if (!token || !owner || !repo) {
                showStatus('authStatus', 'Please fill in repository details and token first', 'error');
                return;
            }

            showStatus('authStatus', 'Checking token permissions...', 'info');

            try {
                // Check repository permissions (this endpoint should work since loading the file works)
                const repoResponse = await fetch(`${apiBase}/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!repoResponse.ok) {
                    throw new Error(`Cannot access repository (${repoResponse.status}) - check owner/repo name and token`);
                }

                const repoData = await repoResponse.json();
                const permissions = repoData.permissions || {};

                // Try to check user (might not work on Enterprise)
                let userName = 'Unknown';
                let scopes = [];
                try {
                    const userResponse = await fetch(`${apiBase}/user`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        userName = userData.login || userData.name || 'Unknown';
                        const scopesHeader = userResponse.headers.get('X-OAuth-Scopes');
                        scopes = scopesHeader ? scopesHeader.split(', ') : [];
                    }
                } catch (e) {
                    // User endpoint might not be available on some Enterprise instances
                }

                // Check branch protection
                let branchProtected = false;
                let branchInfo = '';
                try {
                    const branchResponse = await fetch(`${apiBase}/repos/${owner}/${repo}/branches/${branch}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (branchResponse.ok) {
                        const branchData = await branchResponse.json();
                        branchProtected = branchData.protected || false;
                        branchInfo = branchProtected ? '‚ö†Ô∏è PROTECTED' : '‚úì Not Protected';
                    }
                } catch (e) {
                    branchInfo = '(Unable to check)';
                }

                let statusMessage = `<strong>‚úì Token can access repository</strong><br>`;
                if (userName !== 'Unknown') {
                    statusMessage += `User: ${userName}<br>`;
                }
                statusMessage += `API Base: ${apiBase}<br><br>`;
                
                if (scopes.length > 0) {
                    statusMessage += `<strong>Token Scopes:</strong><br>`;
                    statusMessage += scopes.join(', ') + '<br><br>';
                }
                
                statusMessage += `<strong>Repository Permissions:</strong><br>`;
                statusMessage += `‚Ä¢ Read: ${permissions.pull ? '‚úì Yes' : '‚úó No'}<br>`;
                statusMessage += `‚Ä¢ Write: ${permissions.push ? '‚úì Yes' : '‚úó No'}<br>`;
                statusMessage += `‚Ä¢ Admin: ${permissions.admin ? '‚úì Yes' : '‚úó No'}<br><br>`;
                
                statusMessage += `<strong>Branch Status (${branch}):</strong><br>`;
                statusMessage += branchInfo + '<br><br>';

                if (!permissions.push) {
                    statusMessage += `<strong>‚ö†Ô∏è WARNING: No WRITE permission!</strong><br>`;
                    statusMessage += `Your token lacks write access to this repository.<br>`;
                    statusMessage += `Check with your admin or create a new token with "repo" scope.`;
                    showStatus('authStatus', statusMessage, 'error');
                } else if (branchProtected) {
                    statusMessage += `<strong>‚ö†Ô∏è WARNING: Protected Branch!</strong><br>`;
                    statusMessage += `The branch "${branch}" is protected. You may need:<br>`;
                    statusMessage += `‚Ä¢ Admin/bypass permissions<br>`;
                    statusMessage += `‚Ä¢ Or commit to a different branch`;
                    showStatus('authStatus', statusMessage, 'error');
                } else {
                    statusMessage += `<strong>‚úì Everything looks good!</strong><br>`;
                    statusMessage += `Your token should be able to save files.`;
                    showStatus('authStatus', statusMessage, 'success');
                }

            } catch (error) {
                showStatus('authStatus', `Error checking permissions: ${error.message}`, 'error');
                console.error('Permission check error:', error);
            }
        }

        // Template functionality
        function loadTemplate() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        function showHelpTab(tabName) {
            // Hide all help content
            document.querySelectorAll('.help-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.help-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content
            document.getElementById('help-' + tabName).classList.add('active');
            
            // Activate selected tab
            event.target.classList.add('active');
        }

        function copyToClipboard(text) {
            // Create a temporary textarea element
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                // Show success feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#28a745';
                button.style.color = 'white';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please copy manually.');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function applyTemplate(templateName) {
            const template = templates[templateName];
            if (template) {
                currentData = template;
                document.getElementById('jsonEditorText').value = JSON.stringify(template, null, 2);
                updateFormFromJson();
                updatePreview();
                document.getElementById('editorSection').classList.add('active');
                closeTemplateModal();
                showStatus('authStatus', `‚úì Template "${templateName}" loaded!`, 'success');
                document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
                scheduleAutosave();
            }
        }

        // Diff viewer functionality
        function showDiffAndSave() {
            if (!currentContent) {
                showStatus('editorStatus', 'Please load the file first', 'error');
                return;
            }
            
            const newContent = document.getElementById('jsonEditorText').value;
            
            try {
                JSON.parse(newContent);
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
                return;
            }
            
            // Show diff
            document.getElementById('diffOriginal').textContent = currentContent;
            document.getElementById('diffModified').textContent = newContent;
            document.getElementById('diffModal').classList.add('active');
        }

        function closeDiffModal() {
            document.getElementById('diffModal').classList.remove('active');
        }

        async function confirmSave() {
            closeDiffModal();
            await saveFile();
        }

        // Targeted Announcements
        function addTargetedAnnouncement(data = null) {
            const container = document.getElementById('targetedAnnouncementsContainer');
            const id = targetedAnnouncementCounter++;
            
            const div = document.createElement('div');
            div.className = 'targeted-announcement';
            div.dataset.id = id;
            
            const enabled = data?.Enabled ?? false;
            const appendToDefault = data?.AppendToDefault ?? true;
            
            div.innerHTML = `
                <h5>
                    Targeted Announcement #${id + 1}
                    <button class="btn-danger small" onclick="removeTargetedAnnouncement(${id})" style="padding: 4px 8px;">‚úï Remove</button>
                </h5>
                <div class="checkbox-group">
                    <input type="checkbox" id="targeted_enabled_${id}" ${enabled ? 'checked' : ''} onchange="updateFromForm()">
                    <label for="targeted_enabled_${id}">Enabled</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="targeted_append_${id}" ${appendToDefault ? 'checked' : ''} onchange="updateFromForm()">
                    <label for="targeted_append_${id}">Append to Default Announcement</label>
                </div>
                <div class="form-group">
                    <label>Text:</label>
                    <textarea id="targeted_text_${id}" class="form-textarea" oninput="updateFromForm()">${data?.Text || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Details:</label>
                    <textarea id="targeted_details_${id}" class="form-textarea" oninput="updateFromForm()">${data?.Details || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Links:</label>
                    <div id="targeted_links_${id}"></div>
                    <button class="btn-secondary small" onclick="addLink('targeted_links_${id}')">+ Add Link</button>
                </div>
                <div class="condition-editor">
                    <h6 style="margin-bottom: 8px; color: #856404;">Registry Condition (when to show):</h6>
                    <div class="form-group">
                        <label>Registry Path:</label>
                        <input type="text" id="targeted_reg_path_${id}" value="${data?.Condition?.Path || 'HKLM:\\SOFTWARE\\MITLL\\Targeting'}" oninput="updateFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Value Name:</label>
                        <input type="text" id="targeted_reg_name_${id}" value="${data?.Condition?.Name || 'Group'}" oninput="updateFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Expected Value:</label>
                        <input type="text" id="targeted_reg_value_${id}" value="${data?.Condition?.Value || 'Pilot'}" oninput="updateFromForm()">
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            
            // Add existing links
            if (data?.Links) {
                data.Links.forEach(link => {
                    addLink(`targeted_links_${id}`, link.Name, link.Url);
                });
            }
        }

        function removeTargetedAnnouncement(id) {
            const elem = document.querySelector(`[data-id="${id}"]`);
            if (elem) {
                elem.remove();
                updateFromForm();
            }
        }

        function getTargetedAnnouncements() {
            const targeted = [];
            const container = document.getElementById('targetedAnnouncementsContainer');
            const announcements = container.querySelectorAll('.targeted-announcement');
            
            announcements.forEach(ann => {
                const id = ann.dataset.id;
                targeted.push({
                    Text: document.getElementById(`targeted_text_${id}`).value,
                    Details: document.getElementById(`targeted_details_${id}`).value,
                    Links: getLinksFromContainer(`targeted_links_${id}`),
                    Enabled: document.getElementById(`targeted_enabled_${id}`).checked,
                    AppendToDefault: document.getElementById(`targeted_append_${id}`).checked,
                    Condition: {
                        Type: "Registry",
                        Path: document.getElementById(`targeted_reg_path_${id}`).value,
                        Name: document.getElementById(`targeted_reg_name_${id}`).value,
                        Value: document.getElementById(`targeted_reg_value_${id}`).value
                    }
                });
            });
            
            return targeted;
        }

        function switchMode(mode) {
            const formEditor = document.getElementById('formEditor');
            const jsonEditor = document.getElementById('jsonEditor');
            const formBtn = document.getElementById('formModeBtn');
            const jsonBtn = document.getElementById('jsonModeBtn');
            
            if (mode === 'form') {
                formEditor.classList.add('active');
                jsonEditor.classList.remove('active');
                formBtn.classList.add('active');
                jsonBtn.classList.remove('active');
                updateFormFromJson();
            } else {
                formEditor.classList.remove('active');
                jsonEditor.classList.add('active');
                formBtn.classList.remove('active');
                jsonBtn.classList.add('active');
                updateJsonFromForm();
            }
        }

        function insertMarkdown(textareaId, prefix, suffix) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const newText = prefix + selectedText + suffix;
            
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start + prefix.length;
            textarea.selectionEnd = start + prefix.length + selectedText.length;
            
            updateFromForm();
        }

        function addLink(containerId, name = '', url = '') {
            const container = document.getElementById(containerId);
            const linkDiv = document.createElement('div');
            linkDiv.className = 'link-item';
            linkDiv.innerHTML = `
                <input type="text" placeholder="Link Name" value="${name}" oninput="updateFromForm()">
                <input type="text" placeholder="URL" value="${url}" oninput="updateFromForm()">
                <button class="btn-danger small" onclick="this.parentElement.remove(); updateFromForm()">‚úï</button>
            `;
            container.appendChild(linkDiv);
        }

        function getLinksFromContainer(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const links = [];
            const linkItems = container.querySelectorAll('.link-item');
            
            linkItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const url = inputs[1].value.trim();
                if (name && url) {
                    links.push({ Name: name, Url: url });
                }
            });
            
            return links;
        }

        function updateFromForm() {
            if (isUpdatingFromJson) return;
            
            const data = {
                Announcements: {
                    Default: {
                        Text: document.getElementById('announcementText').value,
                        Details: document.getElementById('announcementDetails').value,
                        Links: getLinksFromContainer('announcementLinks')
                    },
                    Targeted: getTargetedAnnouncements()
                },
                Support: {
                    Text: document.getElementById('supportText').value,
                    Links: getLinksFromContainer('supportLinks')
                }
            };
            
            currentData = data;
            document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
            updatePreview();
            scheduleAutosave();
        }

        function updateFormFromJson() {
            isUpdatingFromJson = true;
            
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                if (!jsonText.trim()) return;
                
                const data = JSON.parse(jsonText);
                currentData = data;
                
                const dashboardData = data.Dashboard || data;
                
                // Update Announcements
                if (dashboardData.Announcements && dashboardData.Announcements.Default) {
                    document.getElementById('announcementText').value = dashboardData.Announcements.Default.Text || '';
                    document.getElementById('announcementDetails').value = dashboardData.Announcements.Default.Details || '';
                    
                    const announcementLinksContainer = document.getElementById('announcementLinks');
                    announcementLinksContainer.innerHTML = '';
                    if (dashboardData.Announcements.Default.Links) {
                        dashboardData.Announcements.Default.Links.forEach(link => {
                            addLink('announcementLinks', link.Name, link.Url);
                        });
                    }
                    
                    // Load targeted announcements
                    const targetedContainer = document.getElementById('targetedAnnouncementsContainer');
                    targetedContainer.innerHTML = '';
                    targetedAnnouncementCounter = 0;
                    if (dashboardData.Announcements.Targeted) {
                        dashboardData.Announcements.Targeted.forEach(targeted => {
                            addTargetedAnnouncement(targeted);
                        });
                    }
                }
                
                // Update Support
                if (dashboardData.Support) {
                    document.getElementById('supportText').value = dashboardData.Support.Text || '';
                    
                    const supportLinksContainer = document.getElementById('supportLinks');
                    supportLinksContainer.innerHTML = '';
                    if (dashboardData.Support.Links) {
                        dashboardData.Support.Links.forEach(link => {
                            addLink('supportLinks', link.Name, link.Url);
                        });
                    }
                }
                
                updatePreview();
            } catch (error) {
                console.error('Error updating form from JSON:', error);
            } finally {
                isUpdatingFromJson = false;
            }
        }

        function updateJsonFromForm() {
            updateFromForm();
        }

        function updateFromJson() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                if (!jsonText.trim()) return;
                
                const data = JSON.parse(jsonText);
                currentData = data;
                updatePreview();
            } catch (error) {
                updatePreview();
            }
        }

        function parseMarkdown(text) {
            if (!text) return '';
            
            text = text.replace(/\[green\](.*?)\[\/green\]/g, '<span class="text-green">$1</span>');
            text = text.replace(/\[red\](.*?)\[\/red\]/g, '<span class="text-red">$1</span>');
            text = text.replace(/\[yellow\](.*?)\[\/yellow\]/g, '<span class="text-yellow">$1</span>');
            text = text.replace(/\[blue\](.*?)\[\/blue\]/g, '<span class="text-blue">$1</span>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/__(.*?)__/g, '<u>$1</u>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        function createSection(title, content, hasAlert = false) {
            const alertHTML = hasAlert ? '<span class="preview-alert"></span>' : '';
            return `
                <div class="preview-section">
                    <div class="preview-section-title" onclick="toggleSection(this)">
                        ${title}${alertHTML}
                    </div>
                    <div class="preview-section-content">
                        ${content}
                    </div>
                </div>
            `;
        }

        function toggleSection(element) {
            element.classList.toggle('collapsed');
            element.nextElementSibling.classList.toggle('collapsed');
        }

        function renderLinks(links) {
            if (!links || links.length === 0) return '';
            let html = '<div style="margin-top: 10px;">';
            links.forEach(link => {
                html += `<a class="preview-link" href="${link.Url}" target="_blank">${link.Name}</a>`;
            });
            html += '</div>';
            return html;
        }

        function updatePreview() {
            const jsonText = document.getElementById('jsonEditorText').value;
            const previewDiv = document.getElementById('previewContent');
            
            if (!jsonText.trim()) {
                previewDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Enter content to see preview</p>';
                return;
            }
            
            try {
                const json = JSON.parse(jsonText);
                let html = '';
                
                const data = json.Dashboard || json;
                
                // Render Announcements
                if (data.Announcements) {
                    const announcements = data.Announcements;
                    let announcementContent = '';
                    
                    if (announcements.Default) {
                        announcementContent += `<div style="margin-bottom: 10px;">${parseMarkdown(announcements.Default.Text)}</div>`;
                        
                        if (announcements.Default.Details) {
                            announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(announcements.Default.Details)}</div>`;
                        }
                        
                        announcementContent += renderLinks(announcements.Default.Links);
                    }
                    
                    if (announcements.Targeted && announcements.Targeted.length > 0) {
                        const enabledTargeted = announcements.Targeted.filter(t => t.Enabled);
                        
                        if (enabledTargeted.length > 0) {
                            announcementContent += '<hr style="margin: 10px 0; border: 1px solid #ddd;">';
                            announcementContent += '<div style="background: #fff9e6; padding: 10px; border-radius: 4px; border-left: 4px solid #ffc107; margin-bottom: 10px;">';
                            announcementContent += '<strong style="color: #856404;">üìç TARGETED ANNOUNCEMENTS PREVIEW</strong><br>';
                            announcementContent += '<small style="color: #856404;">In production, only ONE message shows based on registry condition. Previewing all enabled:</small>';
                            announcementContent += '</div>';
                            
                            enabledTargeted.forEach((targeted, index) => {
                                const conditionLabel = `${targeted.Condition?.Name || 'N/A'} = ${targeted.Condition?.Value || 'N/A'}`;
                                const modeLabel = targeted.AppendToDefault ? 'APPEND MODE' : 'REPLACE MODE (hides default)';
                                
                                announcementContent += `<div style="background: ${targeted.AppendToDefault ? '#f0f8ff' : '#fff3cd'}; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 2px solid ${targeted.AppendToDefault ? '#0078D7' : '#ffc107'};">`;
                                announcementContent += `<div style="margin-bottom: 8px;">`;
                                announcementContent += `<strong style="color: ${targeted.AppendToDefault ? '#0055A4' : '#856404'};">Target #${index + 1}: ${modeLabel}</strong><br>`;
                                announcementContent += `<small style="color: #666;"><strong>Condition:</strong> ${conditionLabel}</small>`;
                                announcementContent += `</div>`;
                                
                                if (!targeted.AppendToDefault) {
                                    announcementContent += `<div style="background: #fff; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #ffc107;">`;
                                    announcementContent += `<small style="color: #856404;"><strong>‚ö†Ô∏è Note:</strong> In Replace mode, the default announcement above will NOT show for users matching this condition.</small>`;
                                    announcementContent += `</div>`;
                                }
                                
                                announcementContent += `<div style="margin-top: 8px;">${parseMarkdown(targeted.Text)}</div>`;
                                
                                if (targeted.Details) {
                                    announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(targeted.Details)}</div>`;
                                }
                                
                                announcementContent += renderLinks(targeted.Links);
                                announcementContent += '</div>';
                            });
                        }
                    }
                    
                    html += createSection('Announcements', announcementContent, true);
                }
                
                // Render Support
                if (data.Support) {
                    let supportContent = parseMarkdown(data.Support.Text);
                    supportContent += renderLinks(data.Support.Links);
                    html += createSection('Support', supportContent);
                }
                
                previewDiv.innerHTML = html || '<p style="text-align: center; color: #666;">No displayable content found</p>';
                
            } catch (error) {
                previewDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; color: #721c24;">
                        <strong>‚ö†Ô∏è JSON Parse Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function loadFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;
            const apiBase = getApiBaseUrl();

            if (!owner || !repo || !branch || !path || !token) {
                showStatus('authStatus', 'Please fill in all fields', 'error');
                return;
            }

            showStatus('authStatus', 'Loading file from GitHub...', 'info');

            try {
                const url = `${apiBase}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                console.log('Loading from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                currentSha = data.sha;
                
                const content = atob(data.content);
                currentContent = content;
                
                document.getElementById('jsonEditorText').value = content;
                formatJson();
                
                updateFormFromJson();
                updatePreview();
                
                showStatus('authStatus', '‚úì File loaded successfully!', 'success');
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showStatus('authStatus', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function saveFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;
            const content = document.getElementById('jsonEditorText').value;
            const apiBase = getApiBaseUrl();

            try {
                JSON.parse(content);
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
                return;
            }

            if (!currentSha) {
                showStatus('editorStatus', 'Please load the file first', 'error');
                return;
            }

            const commitMessage = prompt('Enter commit message:', 'Update ContentData.json via web editor');
            if (!commitMessage) {
                return;
            }

            showStatus('editorStatus', 'Saving to GitHub...', 'info');

            try {
                const url = `${apiBase}/repos/${owner}/${repo}/contents/${path}`;
                
                console.log('Save attempt details:', {
                    url,
                    branch,
                    path,
                    hasSha: !!currentSha,
                    contentLength: content.length,
                    apiBase
                });
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: currentSha,
                        branch: branch
                    })
                });

                if (!response.ok) {
                    let errorDetails = `Status: ${response.status} ${response.statusText}<br>`;
                    
                    // Try to get detailed error message
                    try {
                        const errorData = await response.json();
                        console.error('GitHub API Error:', errorData);
                        
                        errorDetails += `Message: ${errorData.message || 'Unknown error'}<br>`;
                        
                        if (errorData.errors) {
                            errorDetails += `Details: ${JSON.stringify(errorData.errors)}<br>`;
                        }
                        
                        if (errorData.documentation_url) {
                            errorDetails += `<a href="${errorData.documentation_url}" target="_blank">Documentation</a><br>`;
                        }
                    } catch (e) {
                        errorDetails += 'Could not parse error details<br>';
                    }
                    
                    if (response.status === 401) {
                        errorDetails += `<br><strong>Authentication Failed (401)</strong><br>`;
                        errorDetails += `Possible causes:<br>`;
                        errorDetails += `‚Ä¢ Token doesn't have "repo" scope<br>`;
                        errorDetails += `‚Ä¢ Token is expired<br>`;
                        errorDetails += `‚Ä¢ SSO not authorized (Enterprise GitHub)<br>`;
                        errorDetails += `‚Ä¢ Organization restrictions blocking access<br>`;
                        errorDetails += `‚Ä¢ Wrong API Base URL for Enterprise GitHub<br><br>`;
                        errorDetails += `Try:<br>`;
                        errorDetails += `1. Click "Check Token Permissions" button<br>`;
                        errorDetails += `2. Verify API Base URL is correct for Enterprise<br>`;
                        errorDetails += `3. Verify SSO authorization if using Enterprise<br>`;
                        errorDetails += `4. Create a new token with full "repo" scope`;
                    } else if (response.status === 403) {
                        errorDetails += `<br><strong>Forbidden (403)</strong><br>`;
                        errorDetails += `Possible causes:<br>`;
                        errorDetails += `‚Ä¢ Branch is protected<br>`;
                        errorDetails += `‚Ä¢ Repository is archived<br>`;
                        errorDetails += `‚Ä¢ Organization rules blocking write access<br>`;
                        errorDetails += `‚Ä¢ Rate limit exceeded<br>`;
                        errorDetails += `‚Ä¢ Token needs additional permissions`;
                    } else if (response.status === 404) {
                        errorDetails += `<br><strong>Not Found (404)</strong><br>`;
                        errorDetails += `Check: owner, repo name, branch, and file path are correct`;
                    } else if (response.status === 409) {
                        errorDetails += `<br><strong>Conflict (409)</strong><br>`;
                        errorDetails += `The file has been modified since you loaded it.<br>`;
                        errorDetails += `Click "Reload from GitHub" and try again.`;
                    } else if (response.status === 422) {
                        errorDetails += `<br><strong>Unprocessable Entity (422)</strong><br>`;
                        errorDetails += `The request was invalid. This could mean:<br>`;
                        errorDetails += `‚Ä¢ Invalid SHA (file was modified)<br>`;
                        errorDetails += `‚Ä¢ Invalid branch name<br>`;
                        errorDetails += `‚Ä¢ Invalid file content<br>`;
                        errorDetails += `Try reloading the file first.`;
                    }
                    
                    throw new Error(errorDetails);
                }

                const data = await response.json();
                currentSha = data.content.sha;
                currentContent = content;
                
                // Clear autosave after successful save
                localStorage.removeItem('endpointadvisor_autosave');
                localStorage.removeItem('endpointadvisor_autosave_time');

                showStatus('editorStatus', '‚úì File saved successfully to GitHub!', 'success');
            } catch (error) {
                showStatus('editorStatus', `<strong>Error saving file:</strong><br>${error.message}`, 'error');
                console.error('Save error details:', error);
            }
        }

        function validateJson() {
            const content = document.getElementById('jsonEditorText').value;
            const statusDiv = document.getElementById('editorStatus');
            
            try {
                const json = JSON.parse(content);
                const errors = [];
                
                if (json.Dashboard) {
                    if (!json.Dashboard.Announcements) {
                        errors.push('Dashboard.Announcements is missing');
                    } else if (!json.Dashboard.Announcements.Default) {
                        errors.push('Dashboard.Announcements.Default is missing');
                    }
                    if (!json.Dashboard.Support) {
                        errors.push('Dashboard.Support is missing');
                    }
                } else {
                    if (!json.Announcements) {
                        errors.push('Announcements section is missing');
                    } else if (!json.Announcements.Default) {
                        errors.push('Announcements.Default is missing');
                    }
                    if (!json.Support) {
                        errors.push('Support section is missing');
                    }
                }
                
                if (errors.length > 0) {
                    showStatus('editorStatus', `‚ö†Ô∏è Validation warnings: ${errors.join(', ')}`, 'info');
                } else {
                    showStatus('editorStatus', '‚úì JSON is valid and structure looks good!', 'success');
                }
            } catch (error) {
                showStatus('editorStatus', `‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        function formatJson() {
            const content = document.getElementById('jsonEditorText').value;
            try {
                const json = JSON.parse(content);
                const formatted = JSON.stringify(json, null, 2);
                document.getElementById('jsonEditorText').value = formatted;
                updatePreview();
                showStatus('editorStatus', '‚úì JSON formatted successfully', 'success');
            } catch (error) {
                showStatus('editorStatus', `Cannot format - Invalid JSON: ${error.message}`, 'error');
            }
        }

        function resetEditor() {
            if (confirm('Are you sure you want to reload from GitHub? Any unsaved changes will be lost.')) {
                loadFile();
            }
        }

        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            // Convert newlines to <br> for proper display
            const formattedMessage = message.replace(/\n/g, '<br>');
            statusDiv.innerHTML = `<div class="status ${type}">${formattedMessage}</div>`;
        }

        window.addEventListener('beforeunload', (e) => {
            const currentEditorContent = document.getElementById('jsonEditorText').value;
            if (currentContent && currentEditorContent !== currentContent) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
