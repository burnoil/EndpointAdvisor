<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentData.json Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078D7 0%, #0055A4 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
        
        .editor-panel, .preview-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .preview-panel {
            background: #e9ecef;
        }
        
        .panel-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #0078D7;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .autosave-indicator {
            font-size: 11px;
            color: #666;
            font-weight: normal;
        }
        
        .autosave-indicator.saving {
            color: #ffc107;
        }
        
        .autosave-indicator.saved {
            color: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0078D7;
        }
        
        textarea {
            resize: vertical;
            line-height: 1.4;
        }
        
        textarea.code-editor {
            font-family: 'Consolas', 'Monaco', monospace;
            min-height: 500px;
        }
        
        textarea.form-textarea {
            min-height: 80px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button.small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-primary {
            background: #0078D7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0055A4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,215,0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .editor-section {
            display: none;
        }
        
        .editor-section.active {
            display: block;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .help-link {
            color: #0078D7;
            text-decoration: none;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        .preview-window {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 500px;
            max-height: 700px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-header {
            background: #0078D7;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .preview-section {
            border: 1px solid #00008B;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
        }
        
        .preview-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #0078D7;
            cursor: pointer;
            user-select: none;
        }
        
        .preview-section-title:before {
            content: '‚ñº ';
            display: inline-block;
            transition: transform 0.3s;
        }
        
        .preview-section-title.collapsed:before {
            transform: rotate(-90deg);
        }
        
        .preview-section-content {
            font-size: 11px;
            line-height: 1.5;
        }
        
        .preview-section-content.collapsed {
            display: none;
        }
        
        .preview-link {
            color: #0078D7;
            text-decoration: underline;
            cursor: pointer;
            display: block;
            margin-top: 5px;
        }
        
        .preview-alert {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .text-green { color: green; }
        .text-red { color: red; }
        .text-yellow { color: #b8860b; }
        .text-blue { color: blue; }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            color: #0c5460;
            font-size: 13px;
        }
        
        .info-box code {
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        
        .edit-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }
        
        .edit-mode-toggle button {
            flex: 1;
        }
        
        .edit-mode-toggle button.active {
            background: #0078D7;
            color: white;
        }
        
        .form-editor {
            display: none;
        }
        
        .form-editor.active {
            display: block;
        }
        
        .json-editor {
            display: none;
        }
        
        .json-editor.active {
            display: block;
        }
        
        .section-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-card h4 {
            color: #0078D7;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #0078D7;
            padding-bottom: 8px;
        }
        
        .markdown-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .markdown-toolbar button {
            padding: 4px 8px;
            font-size: 12px;
            background: #e9ecef;
            color: #333;
        }
        
        .markdown-toolbar button:hover {
            background: #dee2e6;
            transform: none;
        }
        
        .link-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .link-item input {
            flex: 1;
        }
        
        .link-item button {
            padding: 8px 12px;
        }
        
        .add-link-btn {
            margin-top: 10px;
        }
        
        .form-scroll {
            max-height: 650px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .targeted-announcement {
            border: 2px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background: #fff9e6;
            position: relative;
        }
        
        .targeted-announcement h5 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .condition-editor {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .condition-editor label {
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .condition-editor input {
            font-size: 12px;
            padding: 6px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #0078D7;
            padding-bottom: 10px;
        }
        
        .modal-header h3 {
            color: #0078D7;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .diff-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .diff-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .diff-panel h4 {
            margin-bottom: 10px;
            color: #0078D7;
        }
        
        .diff-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }
        
        .diff-line {
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .diff-added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-removed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .template-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .template-card:hover {
            border-color: #0078D7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,215,0.2);
        }
        
        .template-card h4 {
            color: #0078D7;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .template-card p {
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù ContentData.json Editor</h1>
            <p>Edit your Lincoln Laboratory Endpoint Advisor configuration directly on GitHub</p>
        </div>
        
        <div class="content">
            <!-- Authentication Section -->
            <div id="authSection" class="auth-section">
                <h3>GitHub Authentication</h3>
                <div class="form-group">
                    <label for="repoOwner">Repository Owner:</label>
                    <input type="text" id="repoOwner" value="OwnerName" placeholder="e.g., burnoil">
                </div>
                <div class="form-group">
                    <label for="repoName">Repository Name:</label>
                    <input type="text" id="repoName" value="EndpointAdvisor" placeholder="e.g., EndpointAdvisor">
                </div>
                <div class="form-group">
                    <label for="branch">Branch:</label>
                    <input type="text" id="branch" value="main" placeholder="e.g., main">
                </div>
                <div class="form-group">
                    <label for="filePath">File Path:</label>
                    <input type="text" id="filePath" value="ContentData.json" placeholder="e.g., ContentData.json">
                </div>
                <div class="form-group">
                    <label for="token">GitHub Personal Access Token:</label>
                    <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="help-text">
                        Need a token? Create one at 
                        <a href="https://github.com/settings/tokens/new" target="_blank" class="help-link">GitHub Settings</a>
                        with "repo" scope
                    </p>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="loadFile()">Load File</button>
                    <button class="btn-secondary" onclick="loadTemplate()">üìã Load Template</button>
                    <button class="btn-secondary" onclick="restoreAutosave()">üíæ Restore Auto-save</button>
                </div>
                <div id="authStatus"></div>
            </div>
            
            <!-- Editor Section -->
            <div id="editorSection" class="editor-section">
                <h3>Content Editor with Live Preview</h3>
                
                <div class="info-box">
                    <strong>üìñ Markdown Support:</strong>
                    Use <code>**bold**</code>, <code>*italic*</code>, <code>__underline__</code>, 
                    <code>[green]text[/green]</code>, <code>[red]text[/red]</code>, 
                    <code>[yellow]text[/yellow]</code>, <code>[blue]text[/blue]</code>
                    <span class="autosave-indicator" id="autosaveStatus"></span>
                </div>
                
                <div class="edit-mode-toggle">
                    <button id="formModeBtn" class="active" onclick="switchMode('form')">üìù Form Editor (Easy)</button>
                    <button id="jsonModeBtn" onclick="switchMode('json')">üíª JSON Editor (Advanced)</button>
                </div>
                
                <div class="editor-container">
                    <!-- Form Editor Panel -->
                    <div class="editor-panel">
                        <div class="panel-title">üìù Editor</div>
                        
                        <!-- Form Editor -->
                        <div id="formEditor" class="form-editor active">
                            <div class="form-scroll">
                                <!-- Announcements Section -->
                                <div class="section-card">
                                    <h4>üì¢ Announcements</h4>
                                    <div class="form-group">
                                        <label>Main Text:</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('announcementText', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('announcementText', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('announcementText', '__', '__')"><u>U</u></button>
                                            <button onclick="insertMarkdown('announcementText', '[green]', '[/green]')">üü¢</button>
                                            <button onclick="insertMarkdown('announcementText', '[red]', '[/red]')">üî¥</button>
                                            <button onclick="insertMarkdown('announcementText', '[yellow]', '[/yellow]')">üü°</button>
                                        </div>
                                        <textarea id="announcementText" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Details (Optional):</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('announcementDetails', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('announcementDetails', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('announcementDetails', '__', '__')"><u>U</u></button>
                                        </div>
                                        <textarea id="announcementDetails" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Links:</label>
                                        <div id="announcementLinks"></div>
                                        <button class="btn-secondary small add-link-btn" onclick="addLink('announcementLinks')">+ Add Link</button>
                                    </div>
                                </div>
                                
                                <!-- Targeted Announcements Section -->
                                <div class="section-card">
                                    <h4>üéØ Targeted Announcements</h4>
                                    <p class="help-text" style="margin-bottom: 15px;">Create conditional announcements that appear only for specific users (based on registry keys)</p>
                                    <div id="targetedAnnouncementsContainer"></div>
                                    <button class="btn-secondary small" onclick="addTargetedAnnouncement()">+ Add Targeted Announcement</button>
                                </div>
                                
                                <!-- Support Section -->
                                <div class="section-card">
                                    <h4>üÜò Support</h4>
                                    <div class="form-group">
                                        <label>Support Text:</label>
                                        <div class="markdown-toolbar">
                                            <button onclick="insertMarkdown('supportText', '**', '**')"><b>B</b></button>
                                            <button onclick="insertMarkdown('supportText', '*', '*')"><i>I</i></button>
                                            <button onclick="insertMarkdown('supportText', '__', '__')"><u>U</u></button>
                                        </div>
                                        <textarea id="supportText" class="form-textarea" oninput="updateFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Links:</label>
                                        <div id="supportLinks"></div>
                                        <button class="btn-secondary small add-link-btn" onclick="addLink('supportLinks')">+ Add Link</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JSON Editor -->
                        <div id="jsonEditor" class="json-editor">
                            <textarea id="jsonEditorText" class="code-editor" spellcheck="false"></textarea>
                        </div>
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="preview-panel">
                        <div class="panel-title">
                            üëÅÔ∏è Live Preview
                            <span class="live-indicator"></span>
                        </div>
                        <div class="preview-window" id="previewWindow">
                            <div class="preview-header">Lincoln Laboratory Endpoint Advisor</div>
                            <div id="previewContent">
                                <p style="text-align: center; color: #666; padding: 20px;">
                                    Load or edit content to see preview
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-success" onclick="showDiffAndSave()">üíæ Save to GitHub</button>
                    <button class="btn-secondary" onclick="validateJson()">‚úì Validate JSON</button>
                    <button class="btn-warning" onclick="formatJson()">‚ú® Format/Prettify</button>
                    <button class="btn-secondary" onclick="resetEditor()">üîÑ Reload from GitHub</button>
                </div>
                
                <div id="editorStatus"></div>
            </div>
        </div>
    </div>

    <!-- Diff Modal -->
    <div id="diffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìä Review Changes Before Saving</h3>
                <button class="close-modal" onclick="closeDiffModal()">√ó</button>
            </div>
            <div class="diff-view">
                <div class="diff-panel">
                    <h4>‚ùå Current (GitHub)</h4>
                    <div id="diffOriginal" class="diff-content"></div>
                </div>
                <div class="diff-panel">
                    <h4>‚úÖ New (Your Changes)</h4>
                    <div id="diffModified" class="diff-content"></div>
                </div>
            </div>
            <div class="button-group" style="margin-top: 20px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeDiffModal()">Cancel</button>
                <button class="btn-success" onclick="confirmSave()">Confirm & Save to GitHub</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Choose a Template</h3>
                <button class="close-modal" onclick="closeTemplateModal()">√ó</button>
            </div>
            <div class="template-grid">
                <div class="template-card" onclick="applyTemplate('maintenance')">
                    <h4>üîß System Maintenance</h4>
                    <p>Scheduled maintenance announcement</p>
                </div>
                <div class="template-card" onclick="applyTemplate('security')">
                    <h4>üîí Security Alert</h4>
                    <p>Important security update notice</p>
                </div>
                <div class="template-card" onclick="applyTemplate('patching')">
                    <h4>‚öôÔ∏è Patching Notice</h4>
                    <p>Monthly patch deployment</p>
                </div>
                <div class="template-card" onclick="applyTemplate('training')">
                    <h4>üìö Training Reminder</h4>
                    <p>Required training notification</p>
                </div>
                <div class="template-card" onclick="applyTemplate('holiday')">
                    <h4>üéâ Holiday Schedule</h4>
                    <p>Holiday hours and closures</p>
                </div>
                <div class="template-card" onclick="applyTemplate('pilot')">
                    <h4>üöÄ Pilot Program</h4>
                    <p>Targeted pilot announcement</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSha = null;
        let currentContent = null;
        let currentData = null;
        let isUpdatingFromJson = false;
        let autosaveTimer = null;
        let targetedAnnouncementCounter = 0;

        // Templates
        const templates = {
            maintenance: {
                Announcements: {
                    Default: {
                        Text: "**Scheduled System Maintenance** - [yellow]Systems will be offline[/yellow]",
                        Details: "**Date:** [Specify date and time]\n**Duration:** Approximately 4 hours\n**Impact:** Systems will be unavailable during this window\n\nPlease save your work and log off before maintenance begins.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Questions about the maintenance? Contact IT Support at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            security: {
                Announcements: {
                    Default: {
                        Text: "[red]**SECURITY ALERT**[/red] - Action Required",
                        Details: "A critical security update has been released.\n\n**Action Required:**\n- Update your system immediately\n- Restart your computer when prompted\n- Contact IT if you experience issues",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Security concerns? Contact ISD Support immediately at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            patching: {
                Announcements: {
                    Default: {
                        Text: "**Monthly Patch Deployment** - Windows and Office updates available",
                        Details: "**Starting today** the monthly patches will be made available. Updates will be automatically installed overnight.\n\n[yellow]**Important:**[/yellow] Computers will reboot after installing updates. Save your work before leaving.\n\nDaytime patching begins tomorrow for any computers still needing updates.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Patching issues? Call ISD Support at 781-981-4357 (HELP).",
                    Links: []
                }
            },
            training: {
                Announcements: {
                    Default: {
                        Text: "**Required Training Reminder** - Deadline Approaching",
                        Details: "[red]**Action Required:**[/red] Complete your mandatory security awareness training by [deadline date].\n\n**Steps:**\n1. Log into the training portal\n2. Complete all required modules\n3. Verify completion certificate\n\nFailure to complete may result in system access restrictions.",
                        Links: [
                            { Name: "Training Portal", Url: "https://training.example.com" }
                        ]
                    },
                    Targeted: []
                },
                Support: {
                    Text: "Training questions? Contact Training Team or call 781-981-4357 (HELP).",
                    Links: []
                }
            },
            holiday: {
                Announcements: {
                    Default: {
                        Text: "**Holiday Schedule** - Support Hours Modified",
                        Details: "**Holiday:** [Holiday Name] - [Date]\n\n**ISD Support Center Hours:**\n- [Date]: Closed\n- [Date]: Limited hours (9 AM - 12 PM)\n\n[green]Normal operations resume [date][/green]\n\nEmergency support remains available 24/7.",
                        Links: []
                    },
                    Targeted: []
                },
                Support: {
                    Text: "For emergency support during holidays, call 781-981-4357 (HELP).",
                    Links: []
                }
            },
            pilot: {
                Announcements: {
                    Default: {
                        Text: "No general announcements at this time.",
                        Details: "",
                        Links: []
                    },
                    Targeted: [
                        {
                            Text: "[green]**Pilot Program**[/green] - You've been selected!",
                            Details: "You're part of the [Program Name] pilot group.\n\n**Next Steps:**\n- Review pilot documentation\n- Install pilot software by [date]\n- Provide feedback via survey\n\nThank you for participating!",
                            Links: [
                                { Name: "Pilot Documentation", Url: "https://example.com/pilot" }
                            ],
                            Enabled: true,
                            AppendToDefault: false,
                            Condition: {
                                Type: "Registry",
                                Path: "HKLM:\\SOFTWARE\\MITLL\\Targeting",
                                Name: "Group",
                                Value: "Pilot"
                            }
                        }
                    ]
                },
                Support: {
                    Text: "Pilot program support: email pilot@example.com or call 781-981-4357 (HELP).",
                    Links: []
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const jsonEditorText = document.getElementById('jsonEditorText');
            jsonEditorText.addEventListener('input', debounce(() => {
                if (!isUpdatingFromJson) {
                    updateFromJson();
                    scheduleAutosave();
                }
            }, 500));
            
            checkAutosave();
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Auto-save functionality
        function scheduleAutosave() {
            const status = document.getElementById('autosaveStatus');
            status.textContent = '‚è≥ Saving...';
            status.className = 'autosave-indicator saving';
            
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                const content = document.getElementById('jsonEditorText').value;
                if (content.trim()) {
                    localStorage.setItem('endpointadvisor_autosave', content);
                    localStorage.setItem('endpointadvisor_autosave_time', new Date().toISOString());
                    status.textContent = '‚úì Auto-saved';
                    status.className = 'autosave-indicator saved';
                    setTimeout(() => {
                        status.textContent = '';
                        status.className = 'autosave-indicator';
                    }, 3000);
                }
            }, 2000);
        }

        function checkAutosave() {
            const saved = localStorage.getItem('endpointadvisor_autosave');
            const saveTime = localStorage.getItem('endpointadvisor_autosave_time');
            
            if (saved && saveTime) {
                const time = new Date(saveTime);
                const timeDiff = (new Date() - time) / 1000 / 60; // minutes
                
                if (timeDiff < 60) { // Only show if less than 1 hour old
                    const restoreBtn = document.querySelector('[onclick="restoreAutosave()"]');
                    if (restoreBtn) {
                        restoreBtn.style.background = '#28a745';
                        restoreBtn.style.color = 'white';
                        restoreBtn.textContent = `üíæ Restore Auto-save (${Math.round(timeDiff)} min ago)`;
                    }
                }
            }
        }

        function restoreAutosave() {
            const saved = localStorage.getItem('endpointadvisor_autosave');
            if (saved) {
                if (confirm('Restore your auto-saved work? This will replace any current unsaved changes.')) {
                    document.getElementById('jsonEditorText').value = saved;
                    formatJson();
                    updateFormFromJson();
                    updatePreview();
                    document.getElementById('editorSection').classList.add('active');
                    showStatus('authStatus', '‚úì Auto-saved content restored!', 'success');
                    document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                showStatus('authStatus', 'No auto-saved content found.', 'info');
            }
        }

        // Template functionality
        function loadTemplate() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function applyTemplate(templateName) {
            const template = templates[templateName];
            if (template) {
                currentData = template;
                document.getElementById('jsonEditorText').value = JSON.stringify(template, null, 2);
                updateFormFromJson();
                updatePreview();
                document.getElementById('editorSection').classList.add('active');
                closeTemplateModal();
                showStatus('authStatus', `‚úì Template "${templateName}" loaded!`, 'success');
                document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
                scheduleAutosave();
            }
        }

        // Diff viewer functionality
        function showDiffAndSave() {
            if (!currentContent) {
                showStatus('editorStatus', 'Please load the file first', 'error');
                return;
            }
            
            const newContent = document.getElementById('jsonEditorText').value;
            
            try {
                JSON.parse(newContent);
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
                return;
            }
            
            // Show diff
            document.getElementById('diffOriginal').textContent = currentContent;
            document.getElementById('diffModified').textContent = newContent;
            document.getElementById('diffModal').classList.add('active');
        }

        function closeDiffModal() {
            document.getElementById('diffModal').classList.remove('active');
        }

        async function confirmSave() {
            closeDiffModal();
            await saveFile();
        }

        // Targeted Announcements
        function addTargetedAnnouncement(data = null) {
            const container = document.getElementById('targetedAnnouncementsContainer');
            const id = targetedAnnouncementCounter++;
            
            const div = document.createElement('div');
            div.className = 'targeted-announcement';
            div.dataset.id = id;
            
            const enabled = data?.Enabled ?? false;
            const appendToDefault = data?.AppendToDefault ?? true;
            
            div.innerHTML = `
                <h5>
                    Targeted Announcement #${id + 1}
                    <button class="btn-danger small" onclick="removeTargetedAnnouncement(${id})" style="padding: 4px 8px;">‚úï Remove</button>
                </h5>
                <div class="checkbox-group">
                    <input type="checkbox" id="targeted_enabled_${id}" ${enabled ? 'checked' : ''} onchange="updateFromForm()">
                    <label for="targeted_enabled_${id}">Enabled</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="targeted_append_${id}" ${appendToDefault ? 'checked' : ''} onchange="updateFromForm()">
                    <label for="targeted_append_${id}">Append to Default Announcement</label>
                </div>
                <div class="form-group">
                    <label>Text:</label>
                    <textarea id="targeted_text_${id}" class="form-textarea" oninput="updateFromForm()">${data?.Text || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Details:</label>
                    <textarea id="targeted_details_${id}" class="form-textarea" oninput="updateFromForm()">${data?.Details || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Links:</label>
                    <div id="targeted_links_${id}"></div>
                    <button class="btn-secondary small" onclick="addLink('targeted_links_${id}')">+ Add Link</button>
                </div>
                <div class="condition-editor">
                    <h6 style="margin-bottom: 8px; color: #856404;">Registry Condition (when to show):</h6>
                    <div class="form-group">
                        <label>Registry Path:</label>
                        <input type="text" id="targeted_reg_path_${id}" value="${data?.Condition?.Path || 'HKLM:\\SOFTWARE\\MITLL\\Targeting'}" oninput="updateFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Value Name:</label>
                        <input type="text" id="targeted_reg_name_${id}" value="${data?.Condition?.Name || 'Group'}" oninput="updateFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Expected Value:</label>
                        <input type="text" id="targeted_reg_value_${id}" value="${data?.Condition?.Value || 'Pilot'}" oninput="updateFromForm()">
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            
            // Add existing links
            if (data?.Links) {
                data.Links.forEach(link => {
                    addLink(`targeted_links_${id}`, link.Name, link.Url);
                });
            }
        }

        function removeTargetedAnnouncement(id) {
            const elem = document.querySelector(`[data-id="${id}"]`);
            if (elem) {
                elem.remove();
                updateFromForm();
            }
        }

        function getTargetedAnnouncements() {
            const targeted = [];
            const container = document.getElementById('targetedAnnouncementsContainer');
            const announcements = container.querySelectorAll('.targeted-announcement');
            
            announcements.forEach(ann => {
                const id = ann.dataset.id;
                targeted.push({
                    Text: document.getElementById(`targeted_text_${id}`).value,
                    Details: document.getElementById(`targeted_details_${id}`).value,
                    Links: getLinksFromContainer(`targeted_links_${id}`),
                    Enabled: document.getElementById(`targeted_enabled_${id}`).checked,
                    AppendToDefault: document.getElementById(`targeted_append_${id}`).checked,
                    Condition: {
                        Type: "Registry",
                        Path: document.getElementById(`targeted_reg_path_${id}`).value,
                        Name: document.getElementById(`targeted_reg_name_${id}`).value,
                        Value: document.getElementById(`targeted_reg_value_${id}`).value
                    }
                });
            });
            
            return targeted;
        }

        function switchMode(mode) {
            const formEditor = document.getElementById('formEditor');
            const jsonEditor = document.getElementById('jsonEditor');
            const formBtn = document.getElementById('formModeBtn');
            const jsonBtn = document.getElementById('jsonModeBtn');
            
            if (mode === 'form') {
                formEditor.classList.add('active');
                jsonEditor.classList.remove('active');
                formBtn.classList.add('active');
                jsonBtn.classList.remove('active');
                updateFormFromJson();
            } else {
                formEditor.classList.remove('active');
                jsonEditor.classList.add('active');
                formBtn.classList.remove('active');
                jsonBtn.classList.add('active');
                updateJsonFromForm();
            }
        }

        function insertMarkdown(textareaId, prefix, suffix) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const newText = prefix + selectedText + suffix;
            
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start + prefix.length;
            textarea.selectionEnd = start + prefix.length + selectedText.length;
            
            updateFromForm();
        }

        function addLink(containerId, name = '', url = '') {
            const container = document.getElementById(containerId);
            const linkDiv = document.createElement('div');
            linkDiv.className = 'link-item';
            linkDiv.innerHTML = `
                <input type="text" placeholder="Link Name" value="${name}" oninput="updateFromForm()">
                <input type="text" placeholder="URL" value="${url}" oninput="updateFromForm()">
                <button class="btn-danger small" onclick="this.parentElement.remove(); updateFromForm()">‚úï</button>
            `;
            container.appendChild(linkDiv);
        }

        function getLinksFromContainer(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const links = [];
            const linkItems = container.querySelectorAll('.link-item');
            
            linkItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const url = inputs[1].value.trim();
                if (name && url) {
                    links.push({ Name: name, Url: url });
                }
            });
            
            return links;
        }

        function updateFromForm() {
            if (isUpdatingFromJson) return;
            
            const data = {
                Announcements: {
                    Default: {
                        Text: document.getElementById('announcementText').value,
                        Details: document.getElementById('announcementDetails').value,
                        Links: getLinksFromContainer('announcementLinks')
                    },
                    Targeted: getTargetedAnnouncements()
                },
                Support: {
                    Text: document.getElementById('supportText').value,
                    Links: getLinksFromContainer('supportLinks')
                }
            };
            
            currentData = data;
            document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
            updatePreview();
            scheduleAutosave();
        }

        function updateFormFromJson() {
            isUpdatingFromJson = true;
            
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                if (!jsonText.trim()) return;
                
                const data = JSON.parse(jsonText);
                currentData = data;
                
                const dashboardData = data.Dashboard || data;
                
                // Update Announcements
                if (dashboardData.Announcements && dashboardData.Announcements.Default) {
                    document.getElementById('announcementText').value = dashboardData.Announcements.Default.Text || '';
                    document.getElementById('announcementDetails').value = dashboardData.Announcements.Default.Details || '';
                    
                    const announcementLinksContainer = document.getElementById('announcementLinks');
                    announcementLinksContainer.innerHTML = '';
                    if (dashboardData.Announcements.Default.Links) {
                        dashboardData.Announcements.Default.Links.forEach(link => {
                            addLink('announcementLinks', link.Name, link.Url);
                        });
                    }
                    
                    // Load targeted announcements
                    const targetedContainer = document.getElementById('targetedAnnouncementsContainer');
                    targetedContainer.innerHTML = '';
                    targetedAnnouncementCounter = 0;
                    if (dashboardData.Announcements.Targeted) {
                        dashboardData.Announcements.Targeted.forEach(targeted => {
                            addTargetedAnnouncement(targeted);
                        });
                    }
                }
                
                // Update Support
                if (dashboardData.Support) {
                    document.getElementById('supportText').value = dashboardData.Support.Text || '';
                    
                    const supportLinksContainer = document.getElementById('supportLinks');
                    supportLinksContainer.innerHTML = '';
                    if (dashboardData.Support.Links) {
                        dashboardData.Support.Links.forEach(link => {
                            addLink('supportLinks', link.Name, link.Url);
                        });
                    }
                }
                
                updatePreview();
            } catch (error) {
                console.error('Error updating form from JSON:', error);
            } finally {
                isUpdatingFromJson = false;
            }
        }

        function updateJsonFromForm() {
            updateFromForm();
        }

        function updateFromJson() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                if (!jsonText.trim()) return;
                
                const data = JSON.parse(jsonText);
                currentData = data;
                updatePreview();
            } catch (error) {
                updatePreview();
            }
        }

        function parseMarkdown(text) {
            if (!text) return '';
            
            text = text.replace(/\[green\](.*?)\[\/green\]/g, '<span class="text-green">$1</span>');
            text = text.replace(/\[red\](.*?)\[\/red\]/g, '<span class="text-red">$1</span>');
            text = text.replace(/\[yellow\](.*?)\[\/yellow\]/g, '<span class="text-yellow">$1</span>');
            text = text.replace(/\[blue\](.*?)\[\/blue\]/g, '<span class="text-blue">$1</span>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/__(.*?)__/g, '<u>$1</u>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        function createSection(title, content, hasAlert = false) {
            const alertHTML = hasAlert ? '<span class="preview-alert"></span>' : '';
            return `
                <div class="preview-section">
                    <div class="preview-section-title" onclick="toggleSection(this)">
                        ${title}${alertHTML}
                    </div>
                    <div class="preview-section-content">
                        ${content}
                    </div>
                </div>
            `;
        }

        function toggleSection(element) {
            element.classList.toggle('collapsed');
            element.nextElementSibling.classList.toggle('collapsed');
        }

        function renderLinks(links) {
            if (!links || links.length === 0) return '';
            let html = '<div style="margin-top: 10px;">';
            links.forEach(link => {
                html += `<a class="preview-link" href="${link.Url}" target="_blank">${link.Name}</a>`;
            });
            html += '</div>';
            return html;
        }

        function updatePreview() {
            const jsonText = document.getElementById('jsonEditorText').value;
            const previewDiv = document.getElementById('previewContent');
            
            if (!jsonText.trim()) {
                previewDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Enter content to see preview</p>';
                return;
            }
            
            try {
                const json = JSON.parse(jsonText);
                let html = '';
                
                const data = json.Dashboard || json;
                
                // Render Announcements
                if (data.Announcements) {
                    const announcements = data.Announcements;
                    let announcementContent = '';
                    
                    if (announcements.Default) {
                        announcementContent += `<div style="margin-bottom: 10px;">${parseMarkdown(announcements.Default.Text)}</div>`;
                        
                        if (announcements.Default.Details) {
                            announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(announcements.Default.Details)}</div>`;
                        }
                        
                        announcementContent += renderLinks(announcements.Default.Links);
                    }
                    
                    if (announcements.Targeted && announcements.Targeted.length > 0) {
                        announcements.Targeted.forEach(targeted => {
                            if (targeted.Enabled && targeted.AppendToDefault) {
                                announcementContent += '<hr style="margin: 10px 0; border: 1px solid #ddd;">';
                                announcementContent += `<div style="margin-top: 10px;">${parseMarkdown(targeted.Text)}</div>`;
                                
                                if (targeted.Details) {
                                    announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(targeted.Details)}</div>`;
                                }
                                
                                announcementContent += renderLinks(targeted.Links);
                            }
                        });
                    }
                    
                    html += createSection('Announcements', announcementContent, true);
                }
                
                // Render Support
                if (data.Support) {
                    let supportContent = parseMarkdown(data.Support.Text);
                    supportContent += renderLinks(data.Support.Links);
                    html += createSection('Support', supportContent);
                }
                
                previewDiv.innerHTML = html || '<p style="text-align: center; color: #666;">No displayable content found</p>';
                
            } catch (error) {
                previewDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; color: #721c24;">
                        <strong>‚ö†Ô∏è JSON Parse Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function loadFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;

            if (!owner || !repo || !branch || !path || !token) {
                showStatus('authStatus', 'Please fill in all fields', 'error');
                return;
            }

            showStatus('authStatus', 'Loading file from GitHub...', 'info');

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                currentSha = data.sha;
                
                const content = atob(data.content);
                currentContent = content;
                
                document.getElementById('jsonEditorText').value = content;
                formatJson();
                
                updateFormFromJson();
                updatePreview();
                
                showStatus('authStatus', '‚úì File loaded successfully!', 'success');
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showStatus('authStatus', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function saveFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;
            const content = document.getElementById('jsonEditorText').value;

            try {
                JSON.parse(content);
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
                return;
            }

            if (!currentSha) {
                showStatus('editorStatus', 'Please load the file first', 'error');
                return;
            }

            const commitMessage = prompt('Enter commit message:', 'Update ContentData.json via web editor');
            if (!commitMessage) {
                return;
            }

            showStatus('editorStatus', 'Saving to GitHub...', 'info');

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: btoa(content),
                        sha: currentSha,
                        branch: branch
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                currentSha = data.content.sha;
                currentContent = content;
                
                // Clear autosave after successful save
                localStorage.removeItem('endpointadvisor_autosave');
                localStorage.removeItem('endpointadvisor_autosave_time');

                showStatus('editorStatus', '‚úì File saved successfully to GitHub!', 'success');
            } catch (error) {
                showStatus('editorStatus', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function validateJson() {
            const content = document.getElementById('jsonEditorText').value;
            const statusDiv = document.getElementById('editorStatus');
            
            try {
                const json = JSON.parse(content);
                const errors = [];
                
                if (json.Dashboard) {
                    if (!json.Dashboard.Announcements) {
                        errors.push('Dashboard.Announcements is missing');
                    } else if (!json.Dashboard.Announcements.Default) {
                        errors.push('Dashboard.Announcements.Default is missing');
                    }
                    if (!json.Dashboard.Support) {
                        errors.push('Dashboard.Support is missing');
                    }
                } else {
                    if (!json.Announcements) {
                        errors.push('Announcements section is missing');
                    } else if (!json.Announcements.Default) {
                        errors.push('Announcements.Default is missing');
                    }
                    if (!json.Support) {
                        errors.push('Support section is missing');
                    }
                }
                
                if (errors.length > 0) {
                    showStatus('editorStatus', `‚ö†Ô∏è Validation warnings: ${errors.join(', ')}`, 'info');
                } else {
                    showStatus('editorStatus', '‚úì JSON is valid and structure looks good!', 'success');
                }
            } catch (error) {
                showStatus('editorStatus', `‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        function formatJson() {
            const content = document.getElementById('jsonEditorText').value;
            try {
                const json = JSON.parse(content);
                const formatted = JSON.stringify(json, null, 2);
                document.getElementById('jsonEditorText').value = formatted;
                updatePreview();
                showStatus('editorStatus', '‚úì JSON formatted successfully', 'success');
            } catch (error) {
                showStatus('editorStatus', `Cannot format - Invalid JSON: ${error.message}`, 'error');
            }
        }

        function resetEditor() {
            if (confirm('Are you sure you want to reload from GitHub? Any unsaved changes will be lost.')) {
                loadFile();
            }
        }

        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        window.addEventListener('beforeunload', (e) => {
            const currentEditorContent = document.getElementById('jsonEditorText').value;
            if (currentContent && currentEditorContent !== currentContent) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>