<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentData.json Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0078D7 0%, #0055A4 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 8px 16px;
            background: #0078D7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: #0055A4;
            transform: translateY(-2px);
        }
        
        .preset-btn.active {
            background: #28a745;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
        
        .editor-panel, .preview-panel {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .preview-panel {
            background: #e9ecef;
        }
        
        .panel-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #0078D7;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .autosave-indicator {
            margin-left: auto;
            font-size: 12px;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .autosave-indicator.saving {
            opacity: 1;
            color: #ffc107;
        }
        
        .autosave-indicator.saved {
            opacity: 1;
            color: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0078D7;
            box-shadow: 0 0 0 3px rgba(0,120,215,0.1);
        }
        
        textarea {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .help-link {
            color: #0078D7;
            text-decoration: none;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0078D7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0055A4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,215,0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .editor-section {
            display: none;
        }
        
        .editor-section.active {
            display: block;
        }
        
        .edit-mode-toggle {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
            background: #e9ecef;
            padding: 4px;
            border-radius: 8px;
        }
        
        .edit-mode-toggle button {
            flex: 1;
            padding: 10px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edit-mode-toggle button.active {
            background: white;
            color: #0078D7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #formEditor {
            display: block;
        }
        
        #jsonEditor {
            display: none;
        }
        
        .json-editor-area {
            width: 100%;
            min-height: 500px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .form-editor-content {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .form-section {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .form-section h4 {
            color: #0078D7;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .info-box {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            border-left: 4px solid #0078D7;
        }
        
        .preview-window {
            background: white;
            border-radius: 6px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .preview-section {
            border: 2px solid #00008B;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        
        .preview-section-header {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            color: #00008B;
        }
        
        .preview-content {
            font-size: 13px;
            line-height: 1.6;
        }
        
        .preview-link {
            display: inline-block;
            color: #0078D7;
            text-decoration: none;
            margin: 5px 10px 5px 0;
            font-size: 12px;
        }
        
        .preview-link:hover {
            text-decoration: underline;
        }
        
        .markdown-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .markdown-btn {
            padding: 5px 10px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .markdown-btn:hover {
            background: #dee2e6;
        }
        
        .diff-viewer {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .diff-line {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            padding: 2px 5px;
            white-space: pre-wrap;
        }
        
        .diff-line.added {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-line.removed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .diff-line.unchanged {
            color: #666;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .template-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .template-card:hover {
            border-color: #0078D7;
            box-shadow: 0 4px 12px rgba(0,120,215,0.2);
            transform: translateY(-2px);
        }
        
        .template-card h4 {
            color: #0078D7;
            margin-bottom: 8px;
        }
        
        .template-card p {
            font-size: 13px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #0078D7;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .config-item-info {
            flex: 1;
        }
        
        .config-item-name {
            font-weight: 600;
            color: #333;
        }
        
        .config-item-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .config-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù ContentData.json Editor</h1>
            <p>Edit your Lincoln Laboratory Endpoint Advisor configuration directly on GitHub</p>
        </div>
        
        <div class="content">
            <!-- Authentication Section -->
            <div id="authSection" class="auth-section">
                <h3>GitHub Connection</h3>
                
                <!-- Repository Presets -->
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset('prod')">üè¢ Production</button>
                    <button class="preset-btn" onclick="loadPreset('staging')">üß™ Staging</button>
                    <button class="preset-btn" onclick="loadPreset('dev')">üíª Development</button>
                    <button class="preset-btn" onclick="loadPreset('custom')">‚öôÔ∏è Custom</button>
                    <button class="preset-btn" onclick="showSavedConfigs()">üíæ Saved Configs</button>
                </div>
                
                <!-- GitHub Instance Selection -->
                <div class="form-group">
                    <label for="githubInstance">GitHub Instance:</label>
                    <select id="githubInstance" onchange="handleInstanceChange()">
                        <option value="https://github.ll.mit.edu/api/v3">Lincoln Lab Production (github.ll.mit.edu)</option>
                        <option value="https://github-stage.ll.mit.edu/api/v3">Lincoln Lab Staging (github-stage.ll.mit.edu)</option>
                        <option value="https://github-dev.ll.mit.edu/api/v3">Lincoln Lab Development (github-dev.ll.mit.edu)</option>
                        <option value="https://api.github.com">Public GitHub (github.com)</option>
                        <option value="custom">Custom URL...</option>
                    </select>
                    <input type="text" id="customApiUrl" placeholder="Enter custom API URL (e.g., https://github.company.com/api/v3)" style="display: none; margin-top: 10px;">
                </div>
                
                <div class="form-group">
                    <label for="repoOwner">Repository Owner:</label>
                    <input type="text" id="repoOwner" placeholder="e.g., burnoil">
                </div>
                <div class="form-group">
                    <label for="repoName">Repository Name:</label>
                    <input type="text" id="repoName" placeholder="e.g., EndpointAdvisor">
                </div>
                <div class="form-group">
                    <label for="branch">Branch:</label>
                    <input type="text" id="branch" value="main" placeholder="e.g., main">
                </div>
                <div class="form-group">
                    <label for="filePath">File Path:</label>
                    <input type="text" id="filePath" value="ContentData.json" placeholder="e.g., ContentData.json">
                </div>
                <div class="form-group">
                    <label for="token">GitHub Personal Access Token:</label>
                    <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx">
                    <p class="help-text">
                        Need a token? Create one at your GitHub Settings ‚Üí Tokens with "repo" scope
                    </p>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="loadFile()">üìÇ Load File</button>
                    <button class="btn-secondary" onclick="saveCurrentConfig()">üíæ Save Config</button>
                    <button class="btn-secondary" onclick="loadTemplate()">üìã Load Template</button>
                    <button class="btn-secondary" onclick="restoreAutosave()">üîÑ Restore Auto-save</button>
                </div>
                <div id="authStatus"></div>
            </div>
            
            <!-- Editor Section -->
            <div id="editorSection" class="editor-section">
                <h3>Content Editor with Live Preview</h3>
                
                <div class="info-box">
                    <strong>üìñ Markdown Support:</strong>
                    Use <code>**bold**</code>, <code>*italic*</code>, <code>__underline__</code>, 
                    <code>[green]text[/green]</code>, <code>[red]text[/red]</code>, 
                    <code>[yellow]text[/yellow]</code>, <code>[blue]text[/blue]</code>
                    <span class="autosave-indicator" id="autosaveStatus"></span>
                </div>
                
                <div class="edit-mode-toggle">
                    <button id="formModeBtn" class="active" onclick="switchMode('form')">üìù Form Editor (Easy)</button>
                    <button id="jsonModeBtn" onclick="switchMode('json')">üíª JSON Editor (Advanced)</button>
                </div>
                
                <div class="editor-container">
                    <!-- Editor Panel -->
                    <div class="editor-panel">
                        <div class="panel-title">Editor</div>
                        
                        <!-- Form Editor -->
                        <div id="formEditor">
                            <div class="form-editor-content">
                                <!-- Announcements Section -->
                                <div class="form-section">
                                    <h4>üì¢ Default Announcements</h4>
                                    <div class="form-group">
                                        <label for="annPlatform">Platform:</label>
                                        <select id="annPlatform" onchange="updateJsonFromForm()">
                                            <option value="All">All Platforms</option>
                                            <option value="Windows">Windows Only</option>
                                            <option value="Mac">Mac Only</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="annTitle">Title:</label>
                                        <input type="text" id="annTitle" oninput="updateJsonFromForm()">
                                    </div>
                                    <div class="form-group">
                                        <label for="annText">Message Text:</label>
                                        <div class="markdown-toolbar">
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '**', '**')">Bold</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '*', '*')">Italic</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '__', '__')">Underline</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '[green]', '[/green]')">Green</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '[red]', '[/red]')">Red</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '[yellow]', '[/yellow]')">Yellow</button>
                                            <button class="markdown-btn" onclick="insertMarkdown('annText', '[blue]', '[/blue]')">Blue</button>
                                        </div>
                                        <textarea id="annText" rows="3" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="annDetails">Details (Optional):</label>
                                        <textarea id="annDetails" rows="2" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="annLinks">Links (One per line: Name|URL):</label>
                                        <textarea id="annLinks" rows="3" placeholder="FAQ|https://kb.ll.mit.edu/faq&#10;Support|https://support.ll.mit.edu" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                </div>
                                
                                <!-- Support Section -->
                                <div class="form-section">
                                    <h4>üõ†Ô∏è Support Information</h4>
                                    <div class="form-group">
                                        <label for="supportPlatform">Platform:</label>
                                        <select id="supportPlatform" onchange="updateJsonFromForm()">
                                            <option value="All">All Platforms</option>
                                            <option value="Windows">Windows Only</option>
                                            <option value="Mac">Mac Only</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="supportText">Support Text:</label>
                                        <textarea id="supportText" rows="3" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="supportDetails">Details (Optional):</label>
                                        <textarea id="supportDetails" rows="2" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="supportLinks">Links (One per line: Name|URL):</label>
                                        <textarea id="supportLinks" rows="3" placeholder="Knowledge Base|https://kb.ll.mit.edu&#10;Portal|https://portal.ll.mit.edu" oninput="updateJsonFromForm()"></textarea>
                                    </div>
                                </div>
                                
                                <!-- Targeted Announcements -->
                                <div class="form-section">
                                    <h4>üéØ Targeted Announcements</h4>
                                    <p class="help-text">These appear only when specific registry conditions are met</p>
                                    <div id="targetedAnnouncementsContainer"></div>
                                    <button class="btn-secondary" onclick="addTargetedAnnouncement()" style="margin-top: 10px;">+ Add Targeted Message</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JSON Editor -->
                        <div id="jsonEditor">
                            <textarea id="jsonEditorText" class="json-editor-area" oninput="updatePreview(); scheduleAutosave();"></textarea>
                            <div class="button-group" style="margin-top: 10px;">
                                <button class="btn-secondary" onclick="formatJson()">Format JSON</button>
                                <button class="btn-secondary" onclick="validateJson()">Validate</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="preview-panel">
                        <div class="panel-title">
                            <span>Live Preview</span>
                            <div class="live-indicator"></div>
                        </div>
                        <div id="previewWindow" class="preview-window">
                            <p style="text-align: center; color: #666;">Load a file to see preview</p>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-success" onclick="showDiff()">üëÅÔ∏è Review Changes</button>
                    <button class="btn-primary" onclick="saveFile()">üíæ Save to GitHub</button>
                    <button class="btn-secondary" onclick="downloadJson()">‚¨áÔ∏è Download JSON</button>
                </div>
                <div id="editorStatus"></div>
                
                <!-- Diff Viewer -->
                <div id="diffViewer" style="display: none;">
                    <h4>Changes to be saved:</h4>
                    <div id="diffContent" class="diff-viewer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Choose a Template</h3>
                <button class="close-btn" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="template-grid">
                <div class="template-card" onclick="applyTemplate('maintenance')">
                    <h4>üîß System Maintenance</h4>
                    <p>Scheduled maintenance notification</p>
                </div>
                <div class="template-card" onclick="applyTemplate('security')">
                    <h4>üîí Security Alert</h4>
                    <p>Important security update</p>
                </div>
                <div class="template-card" onclick="applyTemplate('patching')">
                    <h4>‚öôÔ∏è Patching Notice</h4>
                    <p>Software update reminder</p>
                </div>
                <div class="template-card" onclick="applyTemplate('training')">
                    <h4>üìö Training Reminder</h4>
                    <p>Mandatory training notification</p>
                </div>
                <div class="template-card" onclick="applyTemplate('holiday')">
                    <h4>üéâ Holiday Schedule</h4>
                    <p>Office closure information</p>
                </div>
                <div class="template-card" onclick="applyTemplate('pilot')">
                    <h4>üöÄ Pilot Program</h4>
                    <p>Enrollment in pilot group</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Saved Configs Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Saved Configurations</h3>
                <button class="close-btn" onclick="closeModal('configModal')">&times;</button>
            </div>
            <div id="configList"></div>
        </div>
    </div>

    <script>
        let currentContent = '';
        let currentSha = '';
        let autosaveTimer = null;
        
        // Repository Presets
        const presets = {
            prod: {
                instance: 'https://github.ll.mit.edu/api/v3',
                owner: 'EndpointEngineering',
                repo: 'EndpointAdvisor',
                branch: 'main',
                file: 'ContentData.json'
            },
            staging: {
                instance: 'https://github-stage.ll.mit.edu/api/v3',
                owner: 'EndpointEngineering',
                repo: 'EndpointAdvisor-Staging',
                branch: 'main',
                file: 'ContentData.json'
            },
            dev: {
                instance: 'https://github-dev.ll.mit.edu/api/v3',
                owner: 'EndpointEngineering',
                repo: 'EndpointAdvisor-Dev',
                branch: 'dev',
                file: 'ContentData.json'
            },
            custom: {
                instance: 'custom',
                owner: '',
                repo: '',
                branch: 'main',
                file: 'ContentData.json'
            }
        };
        
        // Load preset configuration
        function loadPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            
            document.getElementById('githubInstance').value = preset.instance;
            document.getElementById('repoOwner').value = preset.owner;
            document.getElementById('repoName').value = preset.repo;
            document.getElementById('branch').value = preset.branch;
            document.getElementById('filePath').value = preset.file;
            
            handleInstanceChange();
            
            // Highlight active preset
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        // Handle GitHub instance selection change
        function handleInstanceChange() {
            const select = document.getElementById('githubInstance');
            const customInput = document.getElementById('customApiUrl');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        }
        
        // Get the active API base URL
        function getApiBaseUrl() {
            const select = document.getElementById('githubInstance');
            if (select.value === 'custom') {
                const customUrl = document.getElementById('customApiUrl').value.trim();
                return customUrl || 'https://api.github.com';
            }
            return select.value;
        }
        
        // Save current configuration
        function saveCurrentConfig() {
            const name = prompt('Enter a name for this configuration:');
            if (!name) return;
            
            const config = {
                name: name,
                instance: document.getElementById('githubInstance').value,
                customUrl: document.getElementById('customApiUrl').value,
                owner: document.getElementById('repoOwner').value,
                repo: document.getElementById('repoName').value,
                branch: document.getElementById('branch').value,
                file: document.getElementById('filePath').value,
                token: document.getElementById('token').value
            };
            
            // Get existing configs
            let configs = JSON.parse(localStorage.getItem('ea_saved_configs') || '[]');
            
            // Check if config with same name exists
            const existingIndex = configs.findIndex(c => c.name === name);
            if (existingIndex >= 0) {
                if (!confirm('A configuration with this name already exists. Overwrite?')) {
                    return;
                }
                configs[existingIndex] = config;
            } else {
                configs.push(config);
            }
            
            localStorage.setItem('ea_saved_configs', JSON.stringify(configs));
            showStatus('authStatus', `‚úì Configuration "${name}" saved!`, 'success');
        }
        
        // Show saved configurations
        function showSavedConfigs() {
            const configs = JSON.parse(localStorage.getItem('ea_saved_configs') || '[]');
            const configList = document.getElementById('configList');
            
            if (configs.length === 0) {
                configList.innerHTML = '<p style="text-align: center; color: #666;">No saved configurations</p>';
            } else {
                configList.innerHTML = configs.map((config, index) => `
                    <div class="config-item">
                        <div class="config-item-info">
                            <div class="config-item-name">${config.name}</div>
                            <div class="config-item-details">${config.owner}/${config.repo} (${config.branch})</div>
                        </div>
                        <div class="config-item-actions">
                            <button class="btn-primary icon-btn" onclick="loadSavedConfig(${index})">Load</button>
                            <button class="btn-danger icon-btn" onclick="deleteSavedConfig(${index})">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('configModal').classList.add('active');
        }
        
        // Load a saved configuration
        function loadSavedConfig(index) {
            const configs = JSON.parse(localStorage.getItem('ea_saved_configs') || '[]');
            const config = configs[index];
            
            if (!config) return;
            
            document.getElementById('githubInstance').value = config.instance;
            document.getElementById('customApiUrl').value = config.customUrl || '';
            document.getElementById('repoOwner').value = config.owner;
            document.getElementById('repoName').value = config.repo;
            document.getElementById('branch').value = config.branch;
            document.getElementById('filePath').value = config.file;
            document.getElementById('token').value = config.token;
            
            handleInstanceChange();
            closeModal('configModal');
            showStatus('authStatus', `‚úì Configuration "${config.name}" loaded!`, 'success');
        }
        
        // Delete a saved configuration
        function deleteSavedConfig(index) {
            if (!confirm('Are you sure you want to delete this configuration?')) {
                return;
            }
            
            let configs = JSON.parse(localStorage.getItem('ea_saved_configs') || '[]');
            configs.splice(index, 1);
            localStorage.setItem('ea_saved_configs', JSON.stringify(configs));
            showSavedConfigs(); // Refresh the list
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Switch between form and JSON editing modes
        function switchMode(mode) {
            const formEditor = document.getElementById('formEditor');
            const jsonEditor = document.getElementById('jsonEditor');
            const formBtn = document.getElementById('formModeBtn');
            const jsonBtn = document.getElementById('jsonModeBtn');
            
            if (mode === 'form') {
                formEditor.style.display = 'block';
                jsonEditor.style.display = 'none';
                formBtn.classList.add('active');
                jsonBtn.classList.remove('active');
                updateFormFromJson();
            } else {
                formEditor.style.display = 'none';
                jsonEditor.style.display = 'block';
                formBtn.classList.remove('active');
                jsonBtn.classList.add('active');
            }
        }
        
        // Update form fields from JSON
        function updateFormFromJson() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                const data = JSON.parse(jsonText);
                
                // Handle both old and new JSON structures
                const actualData = data.Data || data;
                
                // Populate Announcements
                if (actualData.Announcements && actualData.Announcements.Default) {
                    const defaultAnn = Array.isArray(actualData.Announcements.Default) 
                        ? actualData.Announcements.Default[0] 
                        : actualData.Announcements.Default;
                    
                    if (defaultAnn) {
                        console.log('Populating form - Details value:', defaultAnn.Details);
                        document.getElementById('annPlatform').value = defaultAnn.Platform || 'All';
                        document.getElementById('annTitle').value = defaultAnn.Title || '';
                        document.getElementById('annText').value = defaultAnn.Text || '';
                        document.getElementById('annDetails').value = defaultAnn.Details || '';
                        document.getElementById('annLinks').value = (defaultAnn.Links || [])
                            .map(link => `${link.Name}|${link.Url}`).join('\n');
                        console.log('Form populated - annDetails element value:', document.getElementById('annDetails').value);
                    }
                }
                
                // Populate Support
                if (actualData.Support) {
                    const support = Array.isArray(actualData.Support) ? actualData.Support[0] : actualData.Support;
                    if (support) {
                        document.getElementById('supportText').value = support.Text || '';
                        document.getElementById('supportDetails').value = support.Details || '';
                        document.getElementById('supportLinks').value = (support.Links || [])
                            .map(link => `${link.Name}|${link.Url}`).join('\n');
                    }
                }
                
                // Populate Targeted Announcements
                if (actualData.Announcements && actualData.Announcements.Targeted) {
                    renderTargetedAnnouncements(actualData.Announcements.Targeted);
                }
                
            } catch (error) {
                console.error('Error updating form:', error);
            }
        }
        
        // Render targeted announcements in form
        function renderTargetedAnnouncements(targeted) {
            const container = document.getElementById('targetedAnnouncementsContainer');
            container.innerHTML = '';
            
            targeted.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'form-section';
                div.style.background = '#f0f8ff';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Targeted Message #${index + 1}</h4>
                        <button class="btn-danger" onclick="removeTargetedAnnouncement(${index})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="targeted_enabled_${index}" ${item.Enabled ? 'checked' : ''} onchange="updateJsonFromForm()">
                        <label for="targeted_enabled_${index}">Enabled</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="targeted_append_${index}" ${item.AppendToDefault ? 'checked' : ''} onchange="updateJsonFromForm()">
                        <label for="targeted_append_${index}">Append to Default (show both)</label>
                    </div>
                    <div class="form-group">
                        <label>Platform:</label>
                        <select id="targeted_platform_${index}" onchange="updateJsonFromForm()">
                            <option value="All" ${item.Platform === 'All' ? 'selected' : ''}>All Platforms</option>
                            <option value="Windows" ${item.Platform === 'Windows' ? 'selected' : ''}>Windows Only</option>
                            <option value="Mac" ${item.Platform === 'Mac' ? 'selected' : ''}>Mac Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title:</label>
                        <input type="text" id="targeted_title_${index}" value="${item.Title || ''}" oninput="updateJsonFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Message Text:</label>
                        <textarea id="targeted_text_${index}" rows="2" oninput="updateJsonFromForm()">${item.Text || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Details (Optional):</label>
                        <textarea id="targeted_details_${index}" rows="2" oninput="updateJsonFromForm()">${item.Details || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Registry Path:</label>
                        <input type="text" id="targeted_path_${index}" value="${item.Condition?.Path || ''}" placeholder="HKLM:\\SOFTWARE\\MITLL\\Targeting" oninput="updateJsonFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Registry Name:</label>
                        <input type="text" id="targeted_name_${index}" value="${item.Condition?.Name || ''}" placeholder="Group" oninput="updateJsonFromForm()">
                    </div>
                    <div class="form-group">
                        <label>Registry Value:</label>
                        <input type="text" id="targeted_value_${index}" value="${item.Condition?.Value || ''}" placeholder="EPI" oninput="updateJsonFromForm()">
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Add new targeted announcement
        function addTargetedAnnouncement() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                const data = JSON.parse(jsonText);
                const actualData = data.Data || data;
                
                if (!actualData.Announcements) actualData.Announcements = {};
                if (!actualData.Announcements.Targeted) actualData.Announcements.Targeted = [];
                
                actualData.Announcements.Targeted.push({
                    id: `tg-custom-${Date.now()}`,
                    Platform: "Windows",
                    Enabled: true,
                    AppendToDefault: true,
                    Title: "New Targeted Message",
                    Text: "Enter your message here",
                    Condition: {
                        Type: "Registry",
                        Path: "HKLM:\\SOFTWARE\\MITLL\\Targeting",
                        Name: "Group",
                        Value: "YourGroup"
                    }
                });
                
                document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
                updateFormFromJson();
                updatePreview();
            } catch (error) {
                console.error('Error adding targeted announcement:', error);
            }
        }
        
        // Remove targeted announcement
        function removeTargetedAnnouncement(index) {
            if (!confirm('Remove this targeted message?')) return;
            
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                const data = JSON.parse(jsonText);
                const actualData = data.Data || data;
                
                if (actualData.Announcements && actualData.Announcements.Targeted) {
                    actualData.Announcements.Targeted.splice(index, 1);
                    document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
                    updateFormFromJson();
                    updatePreview();
                }
            } catch (error) {
                console.error('Error removing targeted announcement:', error);
            }
        }
        
        // Update JSON from form fields
        function updateJsonFromForm() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                const data = JSON.parse(jsonText);
                const actualData = data.Data || data;
                
                // Update Announcements
                if (!actualData.Announcements) actualData.Announcements = {};
                if (!actualData.Announcements.Default) actualData.Announcements.Default = [{}];
                
                const defaultAnn = Array.isArray(actualData.Announcements.Default)
                    ? actualData.Announcements.Default[0]
                    : actualData.Announcements.Default;
                
                defaultAnn.Platform = document.getElementById('annPlatform').value;
                defaultAnn.Title = document.getElementById('annTitle').value;
                defaultAnn.Text = document.getElementById('annText').value;
                defaultAnn.Details = document.getElementById('annDetails').value;
                
                const annLinksText = document.getElementById('annLinks').value;
                defaultAnn.Links = annLinksText.split('\n')
                    .filter(line => line.trim() && line.includes('|'))
                    .map(line => {
                        const [name, url] = line.split('|').map(s => s.trim());
                        return { Name: name, Url: url };
                    });
                
                // Update Support
                if (!actualData.Support) actualData.Support = Array.isArray(actualData.Support) ? [{}] : {};
                
                const support = Array.isArray(actualData.Support) ? actualData.Support[0] : actualData.Support;
                support.Text = document.getElementById('supportText').value;
                support.Details = document.getElementById('supportDetails').value;
                
                const supportLinksText = document.getElementById('supportLinks').value;
                support.Links = supportLinksText.split('\n')
                    .filter(line => line.trim() && line.includes('|'))
                    .map(line => {
                        const [name, url] = line.split('|').map(s => s.trim());
                        return { Name: name, Url: url };
                    });
                
                // Update Targeted Announcements
                if (actualData.Announcements.Targeted) {
                    actualData.Announcements.Targeted.forEach((item, index) => {
                        const enabledEl = document.getElementById(`targeted_enabled_${index}`);
                        const appendEl = document.getElementById(`targeted_append_${index}`);
                        const platformEl = document.getElementById(`targeted_platform_${index}`);
                        const titleEl = document.getElementById(`targeted_title_${index}`);
                        const textEl = document.getElementById(`targeted_text_${index}`);
                        const detailsEl = document.getElementById(`targeted_details_${index}`);
                        const pathEl = document.getElementById(`targeted_path_${index}`);
                        const nameEl = document.getElementById(`targeted_name_${index}`);
                        const valueEl = document.getElementById(`targeted_value_${index}`);
                        
                        if (enabledEl) item.Enabled = enabledEl.checked;
                        if (appendEl) item.AppendToDefault = appendEl.checked;
                        if (platformEl) item.Platform = platformEl.value;
                        if (titleEl) item.Title = titleEl.value;
                        if (textEl) item.Text = textEl.value;
                        if (detailsEl) item.Details = detailsEl.value;
                        
                        if (!item.Condition) item.Condition = { Type: "Registry" };
                        if (pathEl) item.Condition.Path = pathEl.value;
                        if (nameEl) item.Condition.Name = nameEl.value;
                        if (valueEl) item.Condition.Value = valueEl.value;
                    });
                }
                
                document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
                updatePreview();
                scheduleAutosave();
            } catch (error) {
                console.error('Error updating JSON from form:', error);
            }
        }
        
        // Insert markdown formatting
        function insertMarkdown(textareaId, before, after) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const replacement = before + selectedText + after;
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
            
            updateJsonFromForm();
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }
        
        // Parse markdown
        function parseMarkdown(text) {
            if (!text) return '';
            
            let html = text;
            
            // Color tags
            html = html.replace(/\[green\](.*?)\[\/green\]/g, '<span style="color: green;">$1</span>');
            html = html.replace(/\[red\](.*?)\[\/red\]/g, '<span style="color: red;">$1</span>');
            html = html.replace(/\[yellow\](.*?)\[\/yellow\]/g, '<span style="color: #FFA500;">$1</span>');
            html = html.replace(/\[blue\](.*?)\[\/blue\]/g, '<span style="color: blue;">$1</span>');
            
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Underline
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }
        
        // Update preview
        function updatePreview() {
            const previewDiv = document.getElementById('previewWindow');
            const jsonText = document.getElementById('jsonEditorText').value;
            
            if (!jsonText.trim()) {
                previewDiv.innerHTML = '<p style="text-align: center; color: #666;">Enter JSON to see preview</p>';
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                const actualData = data.Data || data;
                
                let html = '';
                
                // Helper function to create section
                function createSection(title, content, expanded = false) {
                    return `
                        <div class="preview-section">
                            <div class="preview-section-header">${title}</div>
                            <div class="preview-content">${content}</div>
                        </div>
                    `;
                }
                
                // Helper function to render links
                function renderLinks(links) {
                    if (!links || links.length === 0) return '';
                    return '<div style="margin-top: 8px;">' + 
                        links.map(link => `<a href="${link.Url}" class="preview-link" target="_blank">${link.Name}</a>`).join('') +
                        '</div>';
                }
                
                // Render Announcements
                if (actualData.Announcements) {
                    const announcements = actualData.Announcements;
                    let announcementContent = '';
                    
                    // Default announcement
                    if (announcements.Default) {
                        const defaultAnn = Array.isArray(announcements.Default) 
                            ? announcements.Default[0] 
                            : announcements.Default;
                        
                        if (defaultAnn) {
                            if (defaultAnn.Title) {
                                announcementContent += `<div style="font-weight: bold; margin-bottom: 5px;">${defaultAnn.Title}</div>`;
                            }
                            
                            announcementContent += parseMarkdown(defaultAnn.Text);
                            
                            if (defaultAnn.Details) {
                                announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(defaultAnn.Details)}</div>`;
                            }
                            
                            announcementContent += renderLinks(defaultAnn.Links);
                        }
                    }
                    
                    // Targeted announcements (show all that are enabled)
                    if (announcements.Targeted && announcements.Targeted.length > 0) {
                        announcements.Targeted.forEach(targeted => {
                            if (targeted.Enabled && targeted.AppendToDefault) {
                                announcementContent += '<hr style="margin: 10px 0; border: 1px solid #ddd;">';
                                if (targeted.Title) {
                                    announcementContent += `<div style="font-weight: bold; margin-bottom: 5px; color: #00008B;">${targeted.Title}</div>`;
                                }
                                announcementContent += `<div style="margin-top: 5px;">${parseMarkdown(targeted.Text)}</div>`;
                                
                                if (targeted.Details) {
                                    announcementContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(targeted.Details)}</div>`;
                                }
                                
                                announcementContent += renderLinks(targeted.Links);
                            }
                        });
                    }
                    
                    html += createSection('Announcements', announcementContent, true);
                }
                
                // Render Support
                if (actualData.Support) {
                    const support = Array.isArray(actualData.Support) ? actualData.Support[0] : actualData.Support;
                    if (support) {
                        let supportContent = parseMarkdown(support.Text);
                        if (support.Details) {
                            supportContent += `<div style="margin-top: 5px; color: #555;">${parseMarkdown(support.Details)}</div>`;
                        }
                        supportContent += renderLinks(support.Links);
                        html += createSection('Support', supportContent);
                    }
                }
                
                previewDiv.innerHTML = html || '<p style="text-align: center; color: #666;">No displayable content found</p>';
                
            } catch (error) {
                previewDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; color: #721c24;">
                        <strong>‚ö†Ô∏è JSON Parse Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function loadFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;
            const apiBase = getApiBaseUrl();

            if (!owner || !repo || !branch || !path || !token) {
                showStatus('authStatus', 'Please fill in all fields', 'error');
                return;
            }

            showStatus('authStatus', 'Loading file from GitHub...', 'info');

            try {
                const url = `${apiBase}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                currentSha = data.sha;
                
                const content = atob(data.content);
                currentContent = content;
                
                document.getElementById('jsonEditorText').value = content;
                formatJson();
                
                updateFormFromJson();
                updatePreview();
                
                showStatus('authStatus', '‚úì File loaded successfully!', 'success');
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showStatus('authStatus', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function saveFile() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branch').value;
            const path = document.getElementById('filePath').value;
            const token = document.getElementById('token').value;
            const content = document.getElementById('jsonEditorText').value;
            const apiBase = getApiBaseUrl();

            try {
                JSON.parse(content);
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
                return;
            }

            if (!currentSha) {
                showStatus('editorStatus', 'Please load the file first', 'error');
                return;
            }

            const commitMessage = prompt('Enter commit message:', 'Update ContentData.json via web editor');
            if (!commitMessage) {
                return;
            }

            showStatus('editorStatus', 'Saving to GitHub...', 'info');

            try {
                const url = `${apiBase}/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: btoa(content),
                        sha: currentSha,
                        branch: branch
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API error: ${response.status} - ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                currentSha = data.content.sha;
                currentContent = content;
                
                // Clear autosave after successful save
                localStorage.removeItem('endpointadvisor_autosave');
                localStorage.removeItem('endpointadvisor_autosave_time');

                showStatus('editorStatus', '‚úì File saved successfully to GitHub!', 'success');
            } catch (error) {
                showStatus('editorStatus', `Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Format JSON
        function formatJson() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                const data = JSON.parse(jsonText);
                document.getElementById('jsonEditorText').value = JSON.stringify(data, null, 2);
                updatePreview();
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
            }
        }
        
        // Validate JSON
        function validateJson() {
            try {
                const jsonText = document.getElementById('jsonEditorText').value;
                JSON.parse(jsonText);
                showStatus('editorStatus', '‚úì JSON is valid!', 'success');
            } catch (error) {
                showStatus('editorStatus', `Invalid JSON: ${error.message}`, 'error');
            }
        }
        
        // Show diff
        function showDiff() {
            const diffViewer = document.getElementById('diffViewer');
            const diffContent = document.getElementById('diffContent');
            
            const oldLines = currentContent.split('\n');
            const newLines = document.getElementById('jsonEditorText').value.split('\n');
            
            let html = '';
            const maxLines = Math.max(oldLines.length, newLines.length);
            
            for (let i = 0; i < maxLines; i++) {
                const oldLine = oldLines[i] || '';
                const newLine = newLines[i] || '';
                
                if (oldLine !== newLine) {
                    if (oldLine) {
                        html += `<div class="diff-line removed">- ${escapeHtml(oldLine)}</div>`;
                    }
                    if (newLine) {
                        html += `<div class="diff-line added">+ ${escapeHtml(newLine)}</div>`;
                    }
                } else {
                    html += `<div class="diff-line unchanged">  ${escapeHtml(oldLine)}</div>`;
                }
            }
            
            diffContent.innerHTML = html || '<p style="text-align: center; color: #666;">No changes</p>';
            diffViewer.style.display = 'block';
            diffViewer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Download JSON
        function downloadJson() {
            const content = document.getElementById('jsonEditorText').value;
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ContentData.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Auto-save functionality
        function scheduleAutosave() {
            const indicator = document.getElementById('autosaveStatus');
            indicator.textContent = 'üíæ Saving...';
            indicator.className = 'autosave-indicator saving';
            
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                const content = document.getElementById('jsonEditorText').value;
                localStorage.setItem('endpointadvisor_autosave', content);
                localStorage.setItem('endpointadvisor_autosave_time', new Date().toISOString());
                
                indicator.textContent = '‚úì Saved';
                indicator.className = 'autosave-indicator saved';
                
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 2000);
            }, 2000);
        }
        
        // Restore autosave
        function restoreAutosave() {
            const saved = localStorage.getItem('endpointadvisor_autosave');
            const savedTime = localStorage.getItem('endpointadvisor_autosave_time');
            
            if (!saved) {
                showStatus('authStatus', 'No auto-saved content found', 'info');
                return;
            }
            
            const time = savedTime ? new Date(savedTime).toLocaleString() : 'unknown time';
            if (confirm(`Restore auto-saved content from ${time}?`)) {
                document.getElementById('jsonEditorText').value = saved;
                updateFormFromJson();
                updatePreview();
                showStatus('authStatus', '‚úì Auto-save restored!', 'success');
                document.getElementById('editorSection').classList.add('active');
            }
        }
        
        // Load template
        function loadTemplate() {
            document.getElementById('templateModal').classList.add('active');
        }
        
        // Apply template
        function applyTemplate(templateName) {
            const templates = {
                maintenance: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "maint-001",
                                Platform: "All",
                                Enabled: true,
                                Title: "Scheduled Maintenance",
                                Text: "[yellow]**System Maintenance Scheduled**[/yellow]",
                                Details: "Our systems will undergo scheduled maintenance this weekend. Some services may be temporarily unavailable.\n\n**Date:** Saturday, [DATE]\n**Time:** 2:00 AM - 6:00 AM ET\n**Impact:** Brief interruptions possible",
                                Links: [
                                    { Name: "Maintenance Details", Url: "https://status.ll.mit.edu" }
                                ]
                            }],
                            Targeted: []
                        },
                        Support: [{
                            id: "support-all-001",
                            Platform: "All",
                            Text: "Contact the ISD Support Center for assistance.",
                            Details: "- Phone: 781-981-XXXX\n- Email: support@ll.mit.edu\n- Hours: 8 AM ‚Äì 5 PM ET",
                            Links: [
                                { Name: "Knowledge Base", Url: "https://kb.ll.mit.edu" },
                                { Name: "Self-Service Portal", Url: "https://portal.ll.mit.edu" }
                            ]
                        }]
                    }
                },
                security: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "sec-001",
                                Platform: "All",
                                Enabled: true,
                                Title: "Security Update Required",
                                Text: "[red]**Important Security Update Available**[/red]",
                                Details: "A critical security update is available for your system. Please install as soon as possible.\n\n**What to do:**\n1. Save your work\n2. Install updates from Settings\n3. Restart when prompted",
                                Links: [
                                    { Name: "Security Bulletin", Url: "https://security.ll.mit.edu" }
                                ]
                            }],
                            Targeted: []
                        },
                        Support: [{
                            id: "support-all-001",
                            Platform: "All",
                            Text: "Contact Security Operations for assistance.",
                            Details: "- Phone: 781-981-XXXX\n- Email: security@ll.mit.edu",
                            Links: [
                                { Name: "Security Resources", Url: "https://security.ll.mit.edu" }
                            ]
                        }]
                    }
                },
                patching: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "patch-001",
                                Platform: "Windows",
                                Enabled: true,
                                Title: "Software Updates Available",
                                Text: "Updates are available for your system.",
                                Details: "Please check Settings ‚Üí Windows Update to install the latest updates.\n\n**Remember to:**\n- Save all work before updating\n- Restart when prompted\n- Check for additional updates after restart",
                                Links: [
                                    { Name: "Update Guide", Url: "https://kb.ll.mit.edu/updates" }
                                ]
                            }],
                            Targeted: []
                        },
                        Support: [{
                            id: "support-win-001",
                            Platform: "Windows",
                            Text: "Contact the ISD Support Center for assistance.",
                            Details: "- Phone: 781-981-XXXX\n- Email: support@ll.mit.edu",
                            Links: [
                                { Name: "Windows Support", Url: "https://kb.ll.mit.edu/windows" }
                            ]
                        }]
                    }
                },
                training: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "train-001",
                                Platform: "All",
                                Enabled: true,
                                Title: "Mandatory Training Reminder",
                                Text: "[blue]**Annual Security Training Due**[/blue]",
                                Details: "All employees must complete annual security awareness training by [DATE].\n\n**To complete:**\n1. Visit the training portal\n2. Complete all modules\n3. Pass the assessment",
                                Links: [
                                    { Name: "Training Portal", Url: "https://training.ll.mit.edu" }
                                ]
                            }],
                            Targeted: []
                        },
                        Support: [{
                            id: "support-all-001",
                            Platform: "All",
                            Text: "Contact HR for training assistance.",
                            Details: "- Email: training@ll.mit.edu",
                            Links: [
                                { Name: "Training FAQ", Url: "https://training.ll.mit.edu/faq" }
                            ]
                        }]
                    }
                },
                holiday: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "holiday-001",
                                Platform: "All",
                                Enabled: true,
                                Title: "Holiday Schedule",
                                Text: "[green]**Office Closure Notice**[/green]",
                                Details: "Our offices will be closed for the [HOLIDAY] holiday.\n\n**Closure dates:** [DATES]\n**Reopening:** [DATE]\n\nEmergency support remains available 24/7.",
                                Links: [
                                    { Name: "Holiday Calendar", Url: "https://calendar.ll.mit.edu" }
                                ]
                            }],
                            Targeted: []
                        },
                        Support: [{
                            id: "support-all-001",
                            Platform: "All",
                            Text: "Emergency support available 24/7.",
                            Details: "- Emergency Phone: 781-981-XXXX",
                            Links: []
                        }]
                    }
                },
                pilot: {
                    schemaVersion: "1.1.0",
                    contentVersion: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
                    Data: {
                        Announcements: {
                            Default: [{
                                id: "def-all-001",
                                Platform: "All",
                                Enabled: true,
                                Title: "Endpoint Advisor",
                                Text: "Welcome to Endpoint Advisor.",
                                Details: "No action required today.",
                                Links: [
                                    { Name: "FAQ", Url: "https://kb.ll.mit.edu/ea-faq" }
                                ]
                            }],
                            Targeted: [{
                                id: "tg-win-pilot-001",
                                Platform: "Windows",
                                Enabled: true,
                                AppendToDefault: true,
                                Title: "Pilot Program",
                                Text: "You are enrolled in the Pilot group.",
                                Details: "Thank you for participating! Feedback is encouraged.\n\nSubmit issues to: endpointengineering@ll.mit.edu",
                                Condition: {
                                    Type: "Registry",
                                    Path: "HKLM:\\SOFTWARE\\MITLL\\Targeting",
                                    Name: "Program",
                                    Value: "Pilot"
                                }
                            }]
                        },
                        Support: [{
                            id: "support-all-001",
                            Platform: "All",
                            Text: "Contact the ISD Support Center for assistance.",
                            Details: "- Phone: 781-981-XXXX\n- Email: support@ll.mit.edu",
                            Links: [
                                { Name: "Knowledge Base", Url: "https://kb.ll.mit.edu" }
                            ]
                        }]
                    }
                }
            };
            
            const template = templates[templateName];
            if (template) {
                document.getElementById('jsonEditorText').value = JSON.stringify(template, null, 2);
                updateFormFromJson();
                updatePreview();
                closeModal('templateModal');
                showStatus('authStatus', `‚úì ${templateName.charAt(0).toUpperCase() + templateName.slice(1)} template loaded!`, 'success');
            }
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            handleInstanceChange();
        });
    </script>
</body>
</html>
